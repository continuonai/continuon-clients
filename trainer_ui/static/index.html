<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer - ContinuonXR</title>
    <link rel="stylesheet" href="/static/cxr-theme.css">
    <link rel="stylesheet" href="/static/shared-nav.css">
    <script src="/static/shared-nav.js"></script>
    <style>
        /* Page-specific styles using CXR theme tokens */
        .hardware-bar {
            background: var(--cxr-surface);
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--cxr-border);
        }

        .status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--cxr-danger);
            box-shadow: 0 0 8px var(--cxr-danger-glow);
        }

        .status-dot.connected {
            background: var(--cxr-success);
            box-shadow: 0 0 8px var(--cxr-success-glow);
        }

        .user-badge {
            background: var(--cxr-elevated);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid var(--cxr-border);
            font-family: var(--font-mono);
        }

        .main {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: var(--space-md);
            padding: var(--space-md);
            height: calc(100vh - 120px);
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            overflow-y: auto;
        }

        /* CENTER PANEL - Claude Code Chat */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .claude-chat-main {
            flex: 1;
            background: var(--cxr-surface);
            border: 2px solid var(--cxr-accent-dim);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .claude-chat-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--cxr-accent), var(--cxr-violet), var(--cxr-accent));
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .claude-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--cxr-border);
            background: var(--cxr-elevated);
        }

        .claude-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .claude-title h2 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, var(--cxr-accent), var(--cxr-violet));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .claude-badge {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            background: var(--cxr-accent-subtle);
            border: 1px solid var(--cxr-accent-dim);
            border-radius: var(--radius-full);
            color: var(--cxr-accent);
            text-transform: uppercase;
        }

        .claude-mode-toggle {
            display: flex;
            gap: var(--space-xs);
        }

        .mode-btn {
            padding: 0.4rem 0.8rem;
            font-family: var(--font-ui);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--cxr-surface);
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-md);
            color: var(--cxr-text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn:hover {
            border-color: var(--cxr-accent-dim);
            color: var(--cxr-text-primary);
        }

        .mode-btn.active {
            background: var(--cxr-accent);
            border-color: var(--cxr-accent);
            color: var(--cxr-void);
        }

        .claude-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .claude-message {
            max-width: 85%;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            line-height: 1.5;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .claude-message.user {
            align-self: flex-end;
            background: var(--cxr-elevated);
            border: 1px solid var(--cxr-border);
            color: var(--cxr-text-primary);
        }

        .claude-message.assistant {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.1), rgba(168, 85, 247, 0.05));
            border: 1px solid var(--cxr-accent-dim);
            border-left: 3px solid var(--cxr-accent);
        }

        .claude-message.system {
            align-self: center;
            background: var(--cxr-deep);
            border: 1px solid var(--cxr-border);
            color: var(--cxr-text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            text-align: center;
            max-width: 100%;
        }

        .claude-message.action {
            align-self: center;
            background: var(--cxr-warm-subtle);
            border: 1px solid var(--cxr-warm);
            color: var(--cxr-warm);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .claude-input-area {
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid var(--cxr-border);
            background: var(--cxr-elevated);
        }

        .claude-input-row {
            display: flex;
            gap: var(--space-sm);
        }

        .claude-input {
            flex: 1;
            padding: 0.9rem var(--space-lg);
            font-family: var(--font-ui);
            font-size: 1rem;
            background: var(--cxr-deep);
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-lg);
            color: var(--cxr-text-primary);
            outline: none;
            transition: all 0.2s ease;
        }

        .claude-input:focus {
            border-color: var(--cxr-accent);
            box-shadow: 0 0 0 3px var(--cxr-accent-subtle), 0 0 20px rgba(0, 240, 255, 0.1);
        }

        .claude-input::placeholder {
            color: var(--cxr-text-muted);
        }

        .claude-send-btn {
            padding: 0.9rem 1.5rem;
            font-family: var(--font-display);
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, var(--cxr-accent), var(--cxr-accent-dim));
            border: none;
            border-radius: var(--radius-lg);
            color: var(--cxr-void);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .claude-send-btn:hover {
            background: var(--cxr-accent-bright);
            box-shadow: 0 0 20px var(--cxr-accent-glow);
            transform: translateY(-1px);
        }

        .claude-quick-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 0.3rem 0.7rem;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            background: var(--cxr-surface);
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-full);
            color: var(--cxr-text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .quick-action:hover {
            border-color: var(--cxr-accent-dim);
            color: var(--cxr-accent);
            background: var(--cxr-accent-subtle);
        }

        /* Compact panels for sidebars */
        .panel-compact {
            background: var(--cxr-surface);
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
        }

        .panel-compact h3 {
            font-family: var(--font-display);
            font-size: 0.7rem;
            color: var(--cxr-accent);
            margin: 0 0 var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .camera-section {
            background: var(--cxr-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--cxr-border);
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .camera-header h3 {
            font-family: var(--font-display);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--cxr-accent);
            margin: 0;
        }

        .camera-container {
            position: relative;
            flex: 1;
            background: var(--cxr-void);
            border-radius: var(--radius-md);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--cxr-border);
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-overlay {
            position: absolute;
            border: 2px solid var(--cxr-success);
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 10px var(--cxr-success-glow);
        }

        .face-label {
            position: absolute;
            top: -24px;
            left: 0;
            background: var(--cxr-success);
            color: var(--cxr-void);
            padding: 2px 8px;
            font-size: 11px;
            font-family: var(--font-mono);
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
        }

        .controls-section {
            background: var(--cxr-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--cxr-border);
        }

        .drive-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-width: 200px;
            margin: 0 auto;
        }

        .drive-btn {
            width: 60px;
            height: 60px;
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-md);
            background: var(--cxr-elevated);
            color: var(--cxr-text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .drive-btn:hover {
            background: var(--cxr-accent-subtle);
            border-color: var(--cxr-accent-dim);
            color: var(--cxr-accent);
        }

        .drive-btn:active, .drive-btn.active {
            background: var(--cxr-accent);
            color: var(--cxr-void);
            transform: scale(0.95);
            box-shadow: 0 0 15px var(--cxr-accent-glow);
        }

        .drive-btn.stop {
            background: var(--cxr-danger);
            border-color: var(--cxr-danger);
            color: white;
        }

        .drive-btn.stop:hover {
            box-shadow: 0 0 15px var(--cxr-danger-glow);
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .panel {
            background: var(--cxr-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--cxr-border);
        }

        .panel h3 {
            font-family: var(--font-display);
            font-size: 0.8rem;
            color: var(--cxr-accent);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .arm-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .joint-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .joint-label {
            width: 20px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            color: var(--cxr-text-muted);
        }

        .joint-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--cxr-border);
            border-radius: 3px;
            outline: none;
        }

        .joint-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--cxr-accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px var(--cxr-accent-glow);
            transition: all 0.15s ease;
        }

        .joint-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 12px var(--cxr-accent-glow);
        }

        .joint-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--cxr-accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px var(--cxr-accent-glow);
        }

        .joint-value {
            width: 40px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            text-align: right;
            color: var(--cxr-text-secondary);
        }

        .gripper-control {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--cxr-border);
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: var(--space-md);
            max-height: 200px;
            padding-right: var(--space-sm);
        }

        .chat-message {
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-sm);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            border: 1px solid transparent;
        }

        .chat-message.user {
            background: var(--cxr-elevated);
            border-color: var(--cxr-border);
        }

        .chat-message.assistant {
            background: var(--cxr-accent-subtle);
            border-color: var(--cxr-accent-dim);
            border-left: 3px solid var(--cxr-accent);
        }

        .chat-message.system {
            background: var(--cxr-deep);
            color: var(--cxr-text-muted);
            font-size: 0.8rem;
            font-family: var(--font-mono);
        }

        .chat-input {
            display: flex;
            gap: var(--space-sm);
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem var(--space-md);
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-md);
            background: var(--cxr-deep);
            color: var(--cxr-text-primary);
            font-family: var(--font-ui);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.15s ease;
        }

        .chat-input input:focus {
            border-color: var(--cxr-accent);
            box-shadow: 0 0 0 3px var(--cxr-accent-subtle);
        }

        .chat-input input::placeholder {
            color: var(--cxr-text-muted);
        }

        .chat-input button {
            padding: 0.75rem 1.25rem;
            border: 1px solid var(--cxr-accent);
            border-radius: var(--radius-md);
            background: var(--cxr-accent);
            color: var(--cxr-void);
            font-family: var(--font-ui);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .chat-input button:hover {
            background: var(--cxr-accent-bright);
            box-shadow: 0 0 15px var(--cxr-accent-glow);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--cxr-border);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-family: var(--font-ui);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .action-btn.record {
            background: var(--cxr-success);
            border-color: var(--cxr-success);
            color: var(--cxr-void);
        }

        .action-btn.record:hover {
            box-shadow: 0 0 12px var(--cxr-success-glow);
        }

        .action-btn.record.recording {
            background: var(--cxr-danger);
            border-color: var(--cxr-danger);
            animation: cxr-pulse-danger 1s infinite;
        }

        .action-btn.speak {
            background: var(--cxr-elevated);
            color: var(--cxr-text-primary);
        }

        .action-btn.speak:hover {
            background: var(--cxr-accent-subtle);
            border-color: var(--cxr-accent-dim);
            color: var(--cxr-accent);
        }

        .action-btn.register {
            background: var(--cxr-violet);
            border-color: var(--cxr-violet);
            color: white;
        }

        .action-btn.register:hover {
            box-shadow: 0 0 12px var(--cxr-violet-glow);
        }

        .action-btn.emergency {
            background: var(--cxr-danger);
            border-color: var(--cxr-danger);
            color: white;
            font-weight: bold;
        }

        .action-btn.emergency:hover {
            box-shadow: 0 0 15px var(--cxr-danger-glow);
        }

        @keyframes cxr-pulse-danger {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 8px var(--cxr-danger-glow);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 20px var(--cxr-danger-glow);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Hardware status panel */
        .hardware-panel {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: #0f3460;
            border-radius: 8px;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .hw-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .hw-item .status-ok {
            color: #4ade80;
        }

        .hw-item .status-mock {
            color: #fbbf24;
        }

        .hw-item .status-na {
            color: #888;
        }

        .mock-badge {
            background: #fbbf24;
            color: #000;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.3rem;
        }

        /* Arm tabs */
        .arm-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .arm-tab {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: #0f3460;
            color: #888;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .arm-tab:hover {
            background: #1a4f8f;
            color: #fff;
        }

        .arm-tab.active {
            background: #e94560;
            color: #fff;
        }

        .arm-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-arms-message {
            color: #888;
            font-size: 0.9rem;
            text-align: center;
            padding: 1rem;
        }

        /* Pose buttons */
        .pose-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .pose-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 4px;
            background: #0f3460;
            color: #fff;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .pose-btn:hover {
            background: #1a4f8f;
        }

        .pose-btn.default {
            border: 1px solid #e94560;
        }

        /* Teaching list */
        .teaching-list {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .teaching-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0.5rem;
            background: #0f3460;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .teaching-item .name {
            font-weight: bold;
        }

        .teaching-item .meta {
            color: #888;
            font-size: 0.65rem;
        }

        .teaching-item .actions {
            display: flex;
            gap: 0.3rem;
        }

        .teaching-item button {
            padding: 0.2rem 0.4rem;
            border: none;
            border-radius: 3px;
            background: #1a4f8f;
            color: #fff;
            cursor: pointer;
            font-size: 0.65rem;
        }

        .teaching-item button:hover {
            background: #e94560;
        }

        .teaching-item button.delete {
            background: #dc2626;
        }

        #teaching-btn.recording {
            background: #dc2626;
            animation: pulse 1s infinite;
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .voice-level {
            flex: 1;
            height: 4px;
            background: #0f3460;
            border-radius: 2px;
            overflow: hidden;
        }

        .voice-level-bar {
            height: 100%;
            background: #4ade80;
            width: 0%;
            transition: width 0.1s;
        }

        /* Modal for face registration */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #16213e;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 1rem;
        }

        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: none;
            border-radius: 8px;
            background: #0f3460;
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .modal-buttons .cancel {
            background: #333;
            color: #fff;
        }

        .modal-buttons .confirm {
            background: #4ade80;
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Hardware status bar -->
    <div class="hardware-bar">
        <div class="hardware-panel" id="hardware-panel">
            <div class="hw-item">
                <span>üß† Hailo:</span>
                <span id="hailo-status" class="status-na">N/A</span>
            </div>
            <div class="hw-item">
                <span>ü¶æ Arm L:</span>
                <span id="arm-0-status" class="status-na">N/A</span>
            </div>
            <div class="hw-item">
                <span>ü¶æ Arm R:</span>
                <span id="arm-1-status" class="status-na">N/A</span>
            </div>
            <div class="hw-item">
                <span>üîä Audio:</span>
                <span id="audio-status" class="status-na">N/A</span>
            </div>
        </div>
        <div class="status">
            <div class="status-dot" id="connection-status"></div>
            <span id="connection-text">Disconnected</span>
            <div class="user-badge" id="user-badge">No face detected</div>
        </div>
    </div>

    <main class="main">
        <!-- LEFT PANEL: Camera & Controls -->
        <div class="left-panel">
            <section class="panel-compact" style="flex-shrink:0;">
                <div class="camera-container" style="height:160px;margin-bottom:var(--space-sm);">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="face-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></canvas>
                </div>
                <div style="display:flex;gap:var(--space-xs);">
                    <button class="action-btn register" onclick="openRegisterModal()" style="flex:1;font-size:0.7rem;padding:0.4rem;">Register Face</button>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Drive (WASD)</h3>
                <div class="drive-controls" style="max-width:150px;">
                    <div></div>
                    <button class="drive-btn" id="btn-forward" data-direction="forward" style="width:45px;height:45px;font-size:1.2rem;">‚Üë</button>
                    <div></div>
                    <button class="drive-btn" id="btn-left" data-direction="left" style="width:45px;height:45px;font-size:1.2rem;">‚Üê</button>
                    <button class="drive-btn stop" id="btn-stop" data-direction="stop" style="width:45px;height:45px;font-size:1rem;">‚ñ†</button>
                    <button class="drive-btn" id="btn-right" data-direction="right" style="width:45px;height:45px;font-size:1.2rem;">‚Üí</button>
                    <div></div>
                    <button class="drive-btn" id="btn-backward" data-direction="backward" style="width:45px;height:45px;font-size:1.2rem;">‚Üì</button>
                    <div></div>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Robot Arms</h3>
                <div class="arm-tabs" id="arm-tabs" style="margin-bottom:0.5rem;"></div>
                <div id="arm-controls-container">
                    <div class="arm-controls" id="arm-controls"></div>
                    <div class="gripper-control" style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--cxr-border);">
                        <div class="joint-control">
                            <span class="joint-label">G</span>
                            <input type="range" class="joint-slider" id="gripper-slider" min="0" max="100" value="0">
                            <span class="joint-value" id="gripper-value">0%</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Actions</h3>
                <div style="display:flex;flex-direction:column;gap:0.4rem;">
                    <button class="action-btn record" id="record-btn" onclick="toggleRecording()" style="width:100%;font-size:0.75rem;">Start Recording</button>
                    <button class="action-btn emergency" onclick="emergencyStop()" style="width:100%;font-size:0.75rem;">EMERGENCY STOP</button>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Voice</h3>
                <div style="display:flex;gap:0.3rem;">
                    <button class="action-btn speak" id="listen-btn" onclick="toggleListening()" style="flex:1;font-size:0.7rem;padding:0.4rem;">üé§ Listen</button>
                    <button class="action-btn speak" onclick="speakTest()" style="flex:1;font-size:0.7rem;padding:0.4rem;">üîä Speak</button>
                </div>
            </section>
        </div>

        <!-- CENTER PANEL: Claude Code Chat (Main Interface) -->
        <div class="center-panel">
            <div class="claude-chat-main">
                <div class="claude-header">
                    <div class="claude-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--cxr-accent);">
                            <circle cx="12" cy="8" r="5"/>
                            <path d="M12 13v8M8 17h8M7 21h10"/>
                        </svg>
                        <h2>Claude Code</h2>
                        <span class="claude-badge">Brain Interface</span>
                    </div>
                    <div class="claude-mode-toggle">
                        <button class="mode-btn active" id="mode-train" onclick="setMode('train')">Training</button>
                        <button class="mode-btn" id="mode-live" onclick="setMode('live')">Live Robot</button>
                    </div>
                </div>
                <div class="claude-messages" id="chat-messages">
                    <div class="claude-message system">
                        Claude Code is your robot's brain interface. Ask questions, give commands, or train new behaviors.
                        <br><br>
                        <strong>Training Mode:</strong> Record actions, teach behaviors, generate training data
                        <br>
                        <strong>Live Mode:</strong> Real-time robot control with inference
                    </div>
                </div>
                <div class="claude-input-area">
                    <div class="claude-input-row">
                        <input type="text" class="claude-input" id="chat-input" placeholder="Talk to your robot... (e.g., 'move forward', 'learn wave', 'what do you see?')" onkeypress="handleChatKeypress(event)">
                        <button class="claude-send-btn" onclick="sendChat()">Send</button>
                    </div>
                    <div class="claude-quick-actions">
                        <button class="quick-action" onclick="quickCmd('status')">status</button>
                        <button class="quick-action" onclick="quickCmd('what do you see?')">vision</button>
                        <button class="quick-action" onclick="quickCmd('move forward')">forward</button>
                        <button class="quick-action" onclick="quickCmd('stop')">stop</button>
                        <button class="quick-action" onclick="quickCmd('home position')">home</button>
                        <button class="quick-action" onclick="quickCmd('start training')">train</button>
                        <button class="quick-action" onclick="quickCmd('generate episode')">episode</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Status & Training -->
        <div class="right-panel">
            <section class="panel-compact">
                <h3>Training Status</h3>
                <div id="training-status" style="font-family:var(--font-mono);font-size:0.75rem;color:var(--cxr-text-secondary);">
                    <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                        <span>Score:</span><span style="color:var(--cxr-success);">96%</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;">
                        <span>Episodes:</span><span id="episode-count">0</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span>Mode:</span><span id="current-mode" style="color:var(--cxr-accent);">Training</span>
                    </div>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Poses</h3>
                <div class="pose-buttons" id="pose-buttons" style="max-height:100px;overflow-y:auto;"></div>
                <div style="display:flex;gap:0.3rem;margin-top:0.5rem;">
                    <input type="text" id="pose-name-input" placeholder="Name" style="flex:1;padding:0.3rem;border-radius:4px;border:1px solid var(--cxr-border);background:var(--cxr-deep);color:var(--cxr-text-primary);font-size:0.75rem;">
                    <button class="action-btn" onclick="savePose()" style="padding:0.3rem 0.6rem;font-size:0.7rem;">Save</button>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Teaching</h3>
                <div style="display:flex;gap:0.3rem;margin-bottom:0.5rem;">
                    <input type="text" id="teaching-name-input" placeholder="Recording" style="flex:1;padding:0.3rem;border-radius:4px;border:1px solid var(--cxr-border);background:var(--cxr-deep);color:var(--cxr-text-primary);font-size:0.75rem;">
                    <button class="action-btn" id="teaching-btn" onclick="toggleTeaching()" style="padding:0.3rem 0.6rem;font-size:0.7rem;">‚è∫ Rec</button>
                </div>
                <div class="teaching-list" id="teaching-list" style="max-height:80px;overflow-y:auto;font-size:0.75rem;"></div>
            </section>

            <section class="panel-compact">
                <h3>Arm Actions</h3>
                <div style="display:flex;flex-wrap:wrap;gap:0.3rem;">
                    <button class="action-btn" onclick="mirrorArms()" style="font-size:0.65rem;padding:0.3rem 0.5rem;">Mirror</button>
                    <button class="action-btn" onclick="syncArms()" style="font-size:0.65rem;padding:0.3rem 0.5rem;">Sync</button>
                    <button class="action-btn" onclick="homeArms()" style="font-size:0.65rem;padding:0.3rem 0.5rem;">Home</button>
                </div>
            </section>

            <section class="panel-compact">
                <h3>Hardware</h3>
                <div id="hardware-status" style="font-family:var(--font-mono);font-size:0.7rem;">
                    <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem;">
                        <span class="cxr-status-dot online" style="width:6px;height:6px;"></span>
                        <span>Hailo-8</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem;">
                        <span class="cxr-status-dot" id="camera-status-dot" style="width:6px;height:6px;"></span>
                        <span>Camera</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.3rem;">
                        <span class="cxr-status-dot" id="arms-status-dot" style="width:6px;height:6px;"></span>
                        <span>Arms</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Face Registration Modal -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <h2>Register Your Face</h2>
            <p style="color:#888;margin-bottom:1rem;font-size:0.9rem;">Look at the camera and enter your name</p>
            <input type="text" id="face-name-input" placeholder="Your name">
            <div class="modal-buttons">
                <button class="cancel" onclick="closeRegisterModal()">Cancel</button>
                <button class="confirm" onclick="registerFace()">Register</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // State
        // ============================================================
        let ws = null;
        let isRecording = false;
        let isListening = false;
        let recognition = null;
        let audioContext = null;
        let analyser = null;

        // Hardware state
        let hardwareStatus = {
            arms: {},
            hailo: { available: false, tops: 0, model: '' },
            audio: { available: false, backend: '' },
            cameras: [],
            is_mock: false
        };
        let currentArmId = 'arm_0';  // Currently selected arm

        // ============================================================
        // WebSocket Connection
        // ============================================================
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                document.getElementById('connection-status').classList.add('connected');
                document.getElementById('connection-text').textContent = 'Connected';
                // Request hardware status, poses, and teachings on connect
                send({ type: 'get_hardware_status' });
                send({ type: 'list_poses' });
                send({ type: 'list_teachings' });
            };

            ws.onclose = () => {
                document.getElementById('connection-status').classList.remove('connected');
                document.getElementById('connection-text').textContent = 'Disconnected';
                setTimeout(connect, 2000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };
        }

        function send(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        function handleServerMessage(data) {
            switch (data.type) {
                case 'state':
                    updateState(data.data);
                    if (data.known_faces) {
                        console.log('Known faces:', data.known_faces);
                    }
                    // Update hardware from state if included
                    if (data.data && data.data.arms) {
                        hardwareStatus.arms = data.data.arms;
                    }
                    break;

                case 'hardware_status':
                    hardwareStatus = data;
                    updateHardwareUI();
                    buildArmTabs();
                    break;

                case 'faces_detected':
                    drawFaces(data.faces);
                    if (data.faces.length > 0 && data.faces[0].name !== 'Unknown') {
                        document.getElementById('user-badge').textContent = `üë§ ${data.faces[0].name}`;
                    }
                    break;

                case 'face_registered':
                    addChatMessage('system', `Face registered for ${data.name}`);
                    closeRegisterModal();
                    break;

                case 'claude_thinking':
                    addChatMessage('system', 'Claude is thinking...');
                    break;

                case 'claude_response':
                    addChatMessage('assistant', data.response);
                    break;

                case 'recording':
                    if (data.status === 'started') {
                        isRecording = true;
                        document.getElementById('record-btn').textContent = '‚èπ Stop Recording';
                        document.getElementById('record-btn').classList.add('recording');
                    } else {
                        isRecording = false;
                        document.getElementById('record-btn').textContent = '‚è∫ Start Recording';
                        document.getElementById('record-btn').classList.remove('recording');
                        if (data.path) {
                            addChatMessage('system', `Recording saved to ${data.path}`);
                        }
                    }
                    break;

                case 'error':
                    addChatMessage('system', `Error: ${data.message}`);
                    break;

                // Pose management
                case 'poses_list':
                    buildPoseButtons(data.poses);
                    break;

                case 'pose_saved':
                    buildPoseButtons(data.poses);
                    addChatMessage('system', `Pose saved: ${data.name}`);
                    break;

                case 'pose_loaded':
                    addChatMessage('system', `Loaded pose: ${data.name}`);
                    break;

                case 'pose_deleted':
                    buildPoseButtons(data.poses);
                    break;

                // Teaching mode
                case 'teachings_list':
                    buildTeachingList(data.teachings);
                    break;

                case 'teaching_started':
                    addChatMessage('system', `Recording started: ${data.name}`);
                    break;

                case 'teaching_stopped':
                    buildTeachingList(data.teachings);
                    addChatMessage('system', `Saved recording: ${data.name} (${data.frame_count} frames)`);
                    break;

                case 'playback_started':
                    addChatMessage('system', `Playing: ${data.name}...`);
                    break;

                case 'playback_complete':
                    addChatMessage('system', `Playback complete: ${data.name}`);
                    break;

                case 'teaching_deleted':
                    buildTeachingList(data.teachings);
                    break;

                case 'training_status':
                    if (data.episodes !== undefined) {
                        updateEpisodeCount(data.episodes);
                    }
                    break;

                case 'mode_changed':
                    addChatMessage('system', `Mode changed to ${data.mode}`);
                    break;

                case 'action_executed':
                    addChatMessage('action', `‚ö° ${data.action}`);
                    break;
            }
        }

        function updateHardwareUI() {
            // Update Hailo status
            const hailoEl = document.getElementById('hailo-status');
            if (hardwareStatus.hailo && hardwareStatus.hailo.available) {
                hailoEl.textContent = `${hardwareStatus.hailo.tops} TOPS`;
                hailoEl.className = hardwareStatus.is_mock ? 'status-mock' : 'status-ok';
            } else {
                hailoEl.textContent = 'N/A';
                hailoEl.className = 'status-na';
            }

            // Update arm statuses
            const arm0El = document.getElementById('arm-0-status');
            const arm1El = document.getElementById('arm-1-status');

            if (hardwareStatus.arms && hardwareStatus.arms.arm_0) {
                const arm0 = hardwareStatus.arms.arm_0;
                arm0El.textContent = arm0.is_mock ? 'Mock' : 'OK';
                arm0El.className = arm0.is_mock ? 'status-mock' : 'status-ok';
            } else {
                arm0El.textContent = 'N/A';
                arm0El.className = 'status-na';
            }

            if (hardwareStatus.arms && hardwareStatus.arms.arm_1) {
                const arm1 = hardwareStatus.arms.arm_1;
                arm1El.textContent = arm1.is_mock ? 'Mock' : 'OK';
                arm1El.className = arm1.is_mock ? 'status-mock' : 'status-ok';
            } else {
                arm1El.textContent = 'N/A';
                arm1El.className = 'status-na';
            }

            // Update audio status
            const audioEl = document.getElementById('audio-status');
            if (hardwareStatus.audio && hardwareStatus.audio.available) {
                audioEl.textContent = hardwareStatus.audio.backend;
                audioEl.className = hardwareStatus.is_mock ? 'status-mock' : 'status-ok';
            } else {
                audioEl.textContent = 'N/A';
                audioEl.className = 'status-na';
            }
        }

        function buildArmTabs() {
            const container = document.getElementById('arm-tabs');
            const controlsContainer = document.getElementById('arm-controls-container');
            const armIds = hardwareStatus.arms ? Object.keys(hardwareStatus.arms) : [];

            if (armIds.length === 0) {
                container.innerHTML = '';
                controlsContainer.innerHTML = '<div class="no-arms-message">No arms detected</div>';
                return;
            }

            // Build tabs
            container.innerHTML = '';
            armIds.forEach((armId, index) => {
                const btn = document.createElement('button');
                btn.className = 'arm-tab' + (armId === currentArmId ? ' active' : '');
                const armInfo = hardwareStatus.arms[armId];
                const label = index === 0 ? 'Left Arm' : 'Right Arm';
                btn.innerHTML = label + (armInfo.is_mock ? '<span class="mock-badge">Mock</span>' : '');
                btn.onclick = () => selectArm(armId);
                container.appendChild(btn);
            });

            // Make sure current arm is valid
            if (!armIds.includes(currentArmId)) {
                currentArmId = armIds[0];
                selectArm(currentArmId);
            }

            // Show controls container
            controlsContainer.style.display = 'block';
        }

        function selectArm(armId) {
            currentArmId = armId;

            // Update tab styles
            document.querySelectorAll('.arm-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const tabIndex = Object.keys(hardwareStatus.arms).indexOf(armId);
            const tabs = document.querySelectorAll('.arm-tab');
            if (tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }

            // Reset sliders to match selected arm state
            if (hardwareStatus.arms && hardwareStatus.arms[armId]) {
                const armState = hardwareStatus.arms[armId];
                if (armState.joints) {
                    armState.joints.forEach((value, i) => {
                        const slider = document.getElementById(`joint-${i}`);
                        if (slider) {
                            slider.value = Math.round(value * 100);
                            document.getElementById(`joint-${i}-value`).textContent = slider.value;
                        }
                    });
                }
                if (armState.gripper !== undefined) {
                    const gripperSlider = document.getElementById('gripper-slider');
                    if (gripperSlider) {
                        gripperSlider.value = Math.round(armState.gripper * 100);
                        document.getElementById('gripper-value').textContent = `${gripperSlider.value}%`;
                    }
                }
            }
        }

        function updateState(state) {
            // Update any state displays if needed
        }

        // ============================================================
        // Poses
        // ============================================================
        let poses = [];

        function requestPoses() {
            send({ type: 'list_poses' });
        }

        function buildPoseButtons(posesList) {
            poses = posesList || [];
            const container = document.getElementById('pose-buttons');
            container.innerHTML = '';

            poses.forEach(pose => {
                const btn = document.createElement('button');
                btn.className = 'pose-btn' + (pose.is_default ? ' default' : '');
                btn.textContent = pose.name;
                btn.onclick = () => loadPose(pose.name);
                container.appendChild(btn);
            });
        }

        function savePose() {
            const name = document.getElementById('pose-name-input').value.trim();
            if (!name) {
                alert('Enter a pose name');
                return;
            }
            send({ type: 'save_pose', name: name, arm_id: currentArmId });
            document.getElementById('pose-name-input').value = '';
        }

        function loadPose(name) {
            send({ type: 'load_pose', name: name, arm_id: currentArmId });
        }

        // ============================================================
        // Teaching Mode
        // ============================================================
        let isTeaching = false;
        let teachings = [];

        function requestTeachings() {
            send({ type: 'list_teachings' });
        }

        function buildTeachingList(teachingsList) {
            teachings = teachingsList || [];
            const container = document.getElementById('teaching-list');
            container.innerHTML = '';

            if (teachings.length === 0) {
                container.innerHTML = '<div style="color:#888;font-size:0.75rem;text-align:center;">No recordings yet</div>';
                return;
            }

            teachings.forEach(rec => {
                const div = document.createElement('div');
                div.className = 'teaching-item';
                div.innerHTML = `
                    <div>
                        <span class="name">${rec.name}</span>
                        <span class="meta">${rec.duration_s.toFixed(1)}s ¬∑ ${rec.frame_count} frames</span>
                    </div>
                    <div class="actions">
                        <button onclick="playbackTeaching('${rec.name}')">‚ñ∂</button>
                        <button class="delete" onclick="deleteTeaching('${rec.name}')">‚úï</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleTeaching() {
            if (isTeaching) {
                send({ type: 'stop_teaching' });
                isTeaching = false;
                document.getElementById('teaching-btn').textContent = '‚è∫ Record';
                document.getElementById('teaching-btn').classList.remove('recording');
            } else {
                const name = document.getElementById('teaching-name-input').value.trim();
                if (!name) {
                    alert('Enter a recording name');
                    return;
                }
                send({ type: 'start_teaching', name: name, arm_id: currentArmId });
                isTeaching = true;
                document.getElementById('teaching-btn').textContent = '‚èπ Stop';
                document.getElementById('teaching-btn').classList.add('recording');
                document.getElementById('teaching-name-input').value = '';
            }
        }

        function playbackTeaching(name) {
            send({ type: 'playback_teaching', name: name, arm_id: currentArmId, speed: 1.0 });
        }

        function deleteTeaching(name) {
            if (confirm(`Delete recording "${name}"?`)) {
                send({ type: 'delete_teaching', name: name });
            }
        }

        // ============================================================
        // Dual Arm Control
        // ============================================================
        function mirrorArms() {
            send({ type: 'mirror_arms', source: currentArmId, invert_x: true });
        }

        function syncArms() {
            // Get current arm state and sync both
            if (hardwareStatus.arms && hardwareStatus.arms[currentArmId]) {
                const arm = hardwareStatus.arms[currentArmId];
                send({ type: 'sync_arms', joints: arm.joints, gripper: arm.gripper });
            }
        }

        function homeArms() {
            send({ type: 'load_pose', name: 'home', arm_id: 'arm_0' });
            send({ type: 'load_pose', name: 'home', arm_id: 'arm_1' });
        }

        // ============================================================
        // Camera
        // ============================================================
        async function initCamera() {
            try {
                // Try to get available cameras first
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                console.log('Available cameras:', cameras.length);

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 },
                    audio: false
                });
                const video = document.getElementById('camera-video');
                video.srcObject = stream;

                // Start sending frames for face recognition
                setInterval(sendCameraFrame, 1000);
                console.log('Camera initialized successfully');
            } catch (err) {
                console.error('Camera error:', err);
                let msg = 'Camera unavailable';
                if (err.name === 'NotAllowedError') {
                    msg = 'Camera access denied - please allow camera in browser settings';
                } else if (err.name === 'NotFoundError') {
                    msg = 'No camera detected - connect a camera and refresh';
                } else if (err.name === 'NotReadableError') {
                    msg = 'Camera in use by another app - close other apps and refresh';
                }
                addChatMessage('system', msg);
            }
        }

        function sendCameraFrame() {
            const video = document.getElementById('camera-video');
            if (!video.srcObject) return;

            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 240;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, 320, 240);

            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            send({ type: 'camera_frame', image: imageData });
        }

        function drawFaces(faces) {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('face-canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Scale factor (we send 320x240, display is larger)
            const scaleX = video.videoWidth / 320;
            const scaleY = video.videoHeight / 240;

            faces.forEach(face => {
                const [left, top, right, bottom] = face.box;
                const x = left * scaleX;
                const y = top * scaleY;
                const w = (right - left) * scaleX;
                const h = (bottom - top) * scaleY;

                ctx.strokeStyle = face.name === 'Unknown' ? '#e94560' : '#4ade80';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);

                ctx.fillStyle = face.name === 'Unknown' ? '#e94560' : '#4ade80';
                ctx.font = '14px sans-serif';
                ctx.fillText(face.name, x, y - 5);
            });
        }

        // ============================================================
        // Face Registration
        // ============================================================
        function openRegisterModal() {
            document.getElementById('register-modal').classList.add('active');
            document.getElementById('face-name-input').focus();
        }

        function closeRegisterModal() {
            document.getElementById('register-modal').classList.remove('active');
            document.getElementById('face-name-input').value = '';
        }

        function registerFace() {
            const name = document.getElementById('face-name-input').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }

            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, 640, 480);

            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            send({ type: 'register_face', name: name, image: imageData });
        }

        // ============================================================
        // Drive Controls
        // ============================================================
        function initDriveControls() {
            const buttons = document.querySelectorAll('.drive-btn');
            buttons.forEach(btn => {
                const direction = btn.dataset.direction;

                btn.addEventListener('mousedown', () => {
                    send({ type: 'drive', direction: direction, speed: 0.5 });
                    btn.classList.add('active');
                });

                btn.addEventListener('mouseup', () => {
                    if (direction !== 'stop') {
                        send({ type: 'drive', direction: 'stop' });
                    }
                    btn.classList.remove('active');
                });

                btn.addEventListener('mouseleave', () => {
                    btn.classList.remove('active');
                });
            });

            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;

                let direction = null;
                switch (e.key.toLowerCase()) {
                    case 'w': direction = 'forward'; break;
                    case 's': direction = 'backward'; break;
                    case 'a': direction = 'left'; break;
                    case 'd': direction = 'right'; break;
                    case ' ': direction = 'stop'; break;
                }

                if (direction) {
                    e.preventDefault();
                    send({ type: 'drive', direction: direction, speed: 0.5 });
                    document.getElementById(`btn-${direction}`)?.classList.add('active');
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.target.tagName === 'INPUT') return;

                const keys = ['w', 's', 'a', 'd'];
                if (keys.includes(e.key.toLowerCase())) {
                    send({ type: 'drive', direction: 'stop' });
                    document.querySelectorAll('.drive-btn').forEach(btn => btn.classList.remove('active'));
                }
            });
        }

        // ============================================================
        // Arm Controls
        // ============================================================
        function initArmControls() {
            const container = document.getElementById('arm-controls');
            container.innerHTML = '';

            // Create 5 joint sliders (joints 0-4) - gripper is separate
            for (let i = 0; i < 5; i++) {
                const div = document.createElement('div');
                div.className = 'joint-control';
                div.innerHTML = `
                    <span class="joint-label">J${i + 1}</span>
                    <input type="range" class="joint-slider" id="joint-${i}" min="-100" max="100" value="0">
                    <span class="joint-value" id="joint-${i}-value">0</span>
                `;
                container.appendChild(div);

                const slider = div.querySelector('input');
                slider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value) / 100;
                    document.getElementById(`joint-${i}-value`).textContent = e.target.value;
                    // Send with current arm_id
                    send({ type: 'arm', arm_id: currentArmId, joint: i, value: value });
                });
            }

            // Gripper
            const gripperSlider = document.getElementById('gripper-slider');
            gripperSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value) / 100;
                document.getElementById('gripper-value').textContent = `${e.target.value}%`;
                // Send with current arm_id
                send({ type: 'gripper', arm_id: currentArmId, value: value });
            });
        }

        // ============================================================
        // Voice
        // ============================================================
        function initVoice() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    const result = event.results[event.results.length - 1];
                    if (result.isFinal) {
                        const text = result[0].transcript;
                        addChatMessage('user', text);
                        send({ type: 'ask_claude', prompt: text });
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('listen-btn').textContent = 'üé§ Listen';
                };
            }

            // Audio level visualization
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;

                const updateLevel = () => {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    document.getElementById('voice-level').style.width = `${Math.min(100, avg * 2)}%`;
                    requestAnimationFrame(updateLevel);
                };
                updateLevel();
            }).catch(err => {
                console.error('Microphone error:', err);
            });
        }

        function toggleListening() {
            if (!recognition) {
                addChatMessage('system', 'Speech recognition not available');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('listen-btn').textContent = 'üé§ Listen';
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('listen-btn').textContent = 'üé§ Listening...';
            }
        }

        function speakTest() {
            send({ type: 'speak', text: 'Hello, I am your robot assistant.' });
        }

        // ============================================================
        // Mode Toggle (Training vs Live Robot)
        // ============================================================
        let currentMode = 'train';  // 'train' or 'live'

        function setMode(mode) {
            currentMode = mode;

            // Update button states
            document.getElementById('mode-train').classList.toggle('active', mode === 'train');
            document.getElementById('mode-live').classList.toggle('active', mode === 'live');

            // Update status display
            const modeDisplay = document.getElementById('current-mode');
            if (modeDisplay) {
                modeDisplay.textContent = mode === 'train' ? 'Training' : 'Live Robot';
                modeDisplay.style.color = mode === 'train' ? 'var(--cxr-accent)' : 'var(--cxr-success)';
            }

            // Update placeholder text based on mode
            const input = document.getElementById('chat-input');
            if (mode === 'train') {
                input.placeholder = "Training mode: 'record action', 'generate episode', 'train model'...";
            } else {
                input.placeholder = "Live mode: 'move forward', 'look around', 'pick up object'...";
            }

            // Notify server of mode change
            send({ type: 'set_mode', mode: mode });

            // Add system message
            const modeNames = {
                'train': 'Training Mode - Recording actions for Brain training',
                'live': 'Live Robot Mode - Real-time inference and control'
            };
            addChatMessage('system', `Switched to ${modeNames[mode]}`);
        }

        // ============================================================
        // Quick Commands
        // ============================================================
        function quickCmd(cmd) {
            const input = document.getElementById('chat-input');
            input.value = cmd;
            sendChat();
        }

        // ============================================================
        // Chat
        // ============================================================
        function addChatMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `claude-message ${role}`;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addChatMessage('user', text);
            // Include current mode in the request
            send({ type: 'ask_claude', prompt: text, mode: currentMode });
            input.value = '';
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') {
                sendChat();
            }
        }

        // ============================================================
        // Recording
        // ============================================================
        function toggleRecording() {
            if (isRecording) {
                send({ type: 'stop_recording' });
            } else {
                send({ type: 'start_recording' });
            }
        }

        function emergencyStop() {
            send({ type: 'emergency_stop' });
            addChatMessage('system', 'üö® EMERGENCY STOP ACTIVATED');
        }

        // ============================================================
        // Training Status Updates
        // ============================================================
        let episodeCount = 0;

        function updateEpisodeCount(count) {
            episodeCount = count;
            const el = document.getElementById('episode-count');
            if (el) el.textContent = count;
        }

        function fetchTrainingStatus() {
            fetch('/api/training/status')
                .then(r => r.json())
                .then(data => {
                    if (data.episodes !== undefined) {
                        updateEpisodeCount(data.episodes);
                    }
                    if (data.score !== undefined) {
                        const scoreEl = document.querySelector('#training-status span[style*="success"]');
                        if (scoreEl) scoreEl.textContent = `${Math.round(data.score * 100)}%`;
                    }
                })
                .catch(() => {});
        }

        // ============================================================
        // Initialize
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            connect();
            initCamera();
            initDriveControls();
            initArmControls();
            initVoice();

            // Initialize mode toggle state
            setMode('train');

            // Fetch training status periodically
            fetchTrainingStatus();
            setInterval(fetchTrainingStatus, 10000);

            // Focus chat input
            document.getElementById('chat-input').focus();
        });
    </script>
</body>
</html>
