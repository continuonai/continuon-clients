
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ContinuonBrain</title>
    <style>
        
    :root {
        --bg-color: #0d0d0d;
        --sidebar-bg: #161616;
        --card-bg: #1e1e1e;
        --accent-color: #00ff88;
        --accent-dim: rgba(0, 255, 136, 0.1);
        --text-color: #e0e0e0;
        --text-dim: #888;
        --border-color: #333;
        --font-main: 'Inter', system-ui, -apple-system, sans-serif;
        --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
        --sidebar-width: 260px;
        --chat-width: 400px;
    }
    
    body { font-family: var(--font-main); background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; height: 100vh; overflow: hidden; }
    
    /* Layout - IDE style with left nav, main content, right chat */
    #sidebar { width: var(--sidebar-width); min-width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding-top: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 10; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
    #sidebar.collapsed { width: 0; min-width: 0; border-right: none; }
    #sidebar .logo { padding: 0 24px 24px; font-weight: 800; font-size: 1.4em; letter-spacing: -0.5px; color: #fff; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
    #sidebar .logo span { color: var(--accent-color); }
    
    #main-area { flex: 1; display: flex; flex-direction: row; overflow: hidden; }
    #content { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
    #chat-sidebar { width: var(--chat-width); min-width: var(--chat-width); background: var(--sidebar-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
    #chat-sidebar.collapsed { width: 0; min-width: 0; border-left: none; }
    
    iframe { flex: 1; border: none; width: 100%; height: 100%; }
    
    /* Toggle Buttons */
    .panel-toggle { position: absolute; top: 10px; z-index: 100; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 1.2em; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .panel-toggle:hover { background: var(--accent-dim); border-color: var(--accent-color); color: var(--accent-color); transform: scale(1.05); }
    .panel-toggle:active { transform: scale(0.95); }
    #toggle-left { left: 10px; }
    #toggle-right { right: 10px; }
    
    /* Navigation */
    #sidebar a { padding: 14px 24px; color: var(--text-dim); text-decoration: none; display: flex; align-items: center; gap: 12px; font-size: 0.95em; transition: all 0.2s ease; border-left: 3px solid transparent; white-space: nowrap; }
    #sidebar a:hover { color: #fff; background: rgba(255,255,255,0.03); }
    #sidebar a.active { background: var(--accent-dim); color: var(--accent-color); border-left-color: var(--accent-color); font-weight: 500; }
    
    /* Icons */
    .icon { width: 20px; text-align: center; }
    
    /* Chat Sidebar */
    .chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 1.1em; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; min-height: 0; }
    .chat-message { display: flex; flex-direction: column; gap: 8px; }
    .chat-message.user { align-items: flex-end; }
    .chat-message.agent { align-items: flex-start; }
    .chat-message .sender { font-size: 0.85em; color: var(--text-dim); font-weight: 600; }
    .chat-message .bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; }
    .chat-message.user .bubble { background: var(--accent-color); color: #000; font-weight: 500; }
    .chat-message.agent .bubble { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
    .chat-input-area { padding: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; flex-shrink: 0; z-index: 10; background: var(--sidebar-bg); }
    .chat-input-area textarea { flex: 1; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 8px; font-family: var(--font-main); font-size: 0.95em; resize: none; min-height: 60px; }
    .chat-input-area textarea:focus { outline: none; border-color: var(--accent-color); }
    .chat-input-area button { padding: 12px 24px; background: var(--accent-color); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .chat-input-area button:hover { background: #00dd77; }
    .chat-input-area button:disabled { background: #333; color: #666; cursor: not-allowed; }
    
    /* System Status Footer in Sidebar */
    .sidebar-footer { margin-top: auto; padding: 20px; font-size: 0.8em; color: var(--text-dim); border-top: 1px solid var(--border-color); }
    .status-dot { width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; display: inline-block; margin-right: 6px; box-shadow: 0 0 8px var(--accent-color); }

    /* Dropdown Menu */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background-color: var(--card-bg); min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.4); z-index: 100; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-top: 8px; }
    .dropdown-content a { color: var(--text-color); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9em; cursor: pointer; transition: background 0.2s; border-left: 3px solid transparent; }
    .dropdown-content a:hover { background-color: #333; border-left-color: var(--accent-color); }
    .shown { display: block; }
    
    /* Modal */
    .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
    .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 0; border: 1px solid var(--border-color); width: 80%; max-width: 600px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 1.2em; color: var(--accent-color); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
    .close:hover, .close:focus { color: #fff; text-decoration: none; cursor: pointer; }
    .modal-body { padding: 20px; }
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--text-dim); font-weight: 500; }
    .info-value { color: #fff; font-family: var(--font-mono); font-size: 0.9em; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
    /* Mobile Responsive */
    @media (max-width: 768px) {
        :root {
            --sidebar-width: 0px;
            --chat-width: 0px;
        }
        
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 80% !important;
            max-width: 300px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        #sidebar.mobile-open {
            transform: translateX(0);
            width: 80% !important;
        }

        #chat-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 90% !important;
            max-width: 360px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        #chat-sidebar.mobile-open {
            transform: translateX(0);
        }

        .panel-toggle {
            top: auto;
            bottom: 20px;
            width: 48px;
            height: 48px;
            font-size: 1.5em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            background: rgba(30,30,30,0.9);
            backdrop-filter: blur(4px);
        }
        
        #toggle-left { left: 20px; }
        #toggle-right { right: 20px; }
        
        /* Adjust Manual Control on Mobile */
        .manual-layout { flex-direction: column; }
        #video-layer { position: fixed; top: 0; height: 50vh; }
        #controls-layer { 
            position: fixed; 
            top: 50vh; 
            left: 0; 
            right: 0; 
            width: 100%; 
            height: 50vh; 
            border-left: none; 
            border-top: 1px solid var(--border-color); 
        }
    }

    </style>
    <!-- Preload Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        let chatHistory = [];
        
        // Panel toggle functions
        function toggleLeftPanel() {
            const sidebar = document.getElementById('sidebar');
            const btn = document.getElementById('toggle-left');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                // Close right if open
                document.getElementById('chat-sidebar').classList.remove('mobile-open');
            } else {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                btn.innerHTML = isCollapsed ? '‚ò∞' : '‚óÄ';
                localStorage.setItem('leftPanelCollapsed', isCollapsed);
            }
        }
        
        function toggleRightPanel() {
            const chatSidebar = document.getElementById('chat-sidebar');
            const btn = document.getElementById('toggle-right');
            
            if (window.innerWidth <= 768) {
                chatSidebar.classList.toggle('mobile-open');
                // Close left if open
                document.getElementById('sidebar').classList.remove('mobile-open');
            } else {
                chatSidebar.classList.toggle('collapsed');
                const isCollapsed = chatSidebar.classList.contains('collapsed');
                btn.innerHTML = isCollapsed ? 'üí¨' : '‚ñ∂';
                localStorage.setItem('rightPanelCollapsed', isCollapsed);
            }
        }
        
        // Restore panel states from localStorage
        function restorePanelStates() {
            if (window.innerWidth <= 768) {
                // Mobile defaults
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('chat-sidebar').classList.add('collapsed');
                return;
            }

            const leftCollapsed = localStorage.getItem('leftPanelCollapsed') === 'true';
            const rightCollapsed = localStorage.getItem('rightPanelCollapsed') === 'true';
            
            if (leftCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('toggle-left').innerHTML = '‚ò∞';
            }
            
            if (rightCollapsed) {
                document.getElementById('chat-sidebar').classList.add('collapsed');
                document.getElementById('toggle-right').innerHTML = 'üí¨';
            }
        }
        
        function selectNav(el) {
            document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Get or create session ID for multi-turn context
            let sessionId = localStorage.getItem('chatSessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('chatSessionId', sessionId);
            }
            
            // Add user message
            addMessage('user', 'You', message);
            input.value = '';
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Show agent status
            showAgentStatus('thinking', 'Thinking...');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, history: chatHistory, session_id: sessionId })
                });
                const data = await response.json();
                
                // Hide agent status
                hideAgentStatus();
                
                // Check for intervention needed
                if (data.intervention_needed) {
                    showInterventionPrompt(data.intervention_question, data.intervention_options);
                }
                
                // Check for status updates
                if (data.status_updates && data.status_updates.length > 0) {
                    for (const update of data.status_updates) {
                        addStatusUpdate(update);
                    }
                }
                
                // Store timestamp for validation
                const timestamp = new Date().toISOString();
                addMessage('agent', 'Agent Manager', data.response || 'No response', timestamp);
            } catch(e) {
                hideAgentStatus();
                addMessage('agent', 'Agent Manager', 'Error: ' + e.message);
            }
            
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }
        
        async function validateResponse(timestamp, validated) {
            try {
                const response = await fetch('/api/agent/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timestamp, validated })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Visual feedback
                    const emoji = validated ? '‚úÖ' : '‚ùå';
                    addMessage('system', 'System', `${emoji} Response marked as ${validated ? 'correct' : 'incorrect'}`);
                } else {
                    console.error('Validation failed:', data.error);
                }
            } catch(e) {
                console.error('Validation error:', e);
            }
        }
        
        function showAgentStatus(state, text) {
            const statusBar = document.getElementById('agent-status-bar');
            const statusText = document.getElementById('agent-status-text');
            const progress = document.getElementById('agent-progress');
            
            statusBar.style.display = 'block';
            statusText.textContent = '‚óè ' + text;
            
            if (state === 'thinking') {
                progress.style.display = 'block';
                animateProgress();
            }
        }
        
        function hideAgentStatus() {
            const statusBar = document.getElementById('agent-status-bar');
            const progress = document.getElementById('agent-progress');
            statusBar.style.display = 'none';
            progress.style.display = 'none';
        }
        
        function animateProgress() {
            const bar = document.getElementById('progress-bar');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 10;
                    bar.style.width = Math.min(width, 90) + '%';
                }
            }, 200);
        }
        
        function showInterventionPrompt(question, options) {
            const prompt = document.getElementById('intervention-prompt');
            const questionEl = document.getElementById('intervention-question');
            const optionsEl = document.getElementById('intervention-options');
            
            questionEl.textContent = question;
            optionsEl.innerHTML = '';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.textContent = option;
                btn.style.cssText = 'padding: 8px 16px; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 6px; cursor: pointer; font-size: 0.9em;';
                btn.onmouseover = () => btn.style.background = '#333';
                btn.onmouseout = () => btn.style.background = 'var(--card-bg)';
                btn.onclick = () => {
                    prompt.style.display = 'none';
                    document.getElementById('chatInput').value = option;
                    sendMessage();
                };
                optionsEl.appendChild(btn);
            });
            
            prompt.style.display = 'block';
        }
        
        function addStatusUpdate(update) {
            const messagesDiv = document.getElementById('chatMessages');
            const updateDiv = document.createElement('div');
            updateDiv.style.cssText = 'padding: 8px 12px; margin: 8px 0; background: rgba(0,255,136,0.05); border-left: 3px solid var(--accent-color); border-radius: 4px; font-size: 0.85em; color: var(--text-dim);';
            updateDiv.innerHTML = `<span style="color: var(--accent-color);">‚óè</span> ${escapeHtml(update)}`;
            messagesDiv.appendChild(updateDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addMessage(type, sender, text, timestamp) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            // Add validation buttons for agent messages
            let validationHTML = '';
            if (type === 'agent' && timestamp) {
                validationHTML = `
                    <div class="validation-buttons" style="margin-top: 8px; opacity: 0.6; transition: opacity 0.2s;">
                        <button onclick="validateResponse('${timestamp}', true)" 
                                style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 4px 8px; transition: transform 0.1s;"
                                title="Mark as correct"
                                onmouseover="this.style.transform='scale(1.2)'"
                                onmouseout="this.style.transform='scale(1)'"
                                >üëç</button>
                        <button onclick="validateResponse('${timestamp}', false)" 
                                style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 4px 8px; transition: transform 0.1s;"
                                title="Mark as incorrect"
                                onmouseover="this.style.transform='scale(1.2)'"
                                onmouseout="this.style.transform='1)'"
                                >üëé</button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <div class="bubble">${escapeHtml(text)}</div>
                ${validationHTML}
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            chatHistory.push({ role: type === 'user' ? 'user' : 'assistant', content: text });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        function startNewSession() {
            // Clear session ID to start fresh
            localStorage.removeItem('chatSessionId');
            
            // Clear chat history
            chatHistory = [];
            
            // Clear chat messages display
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';
            
            // Add system message
            addMessage('system', 'System', 'üîÑ New conversation session started');
        }
        
        // Handle Enter key and restore panel states on load
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('chatInput');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Restore panel states
            restorePanelStates();
            
            // Fetch Agent Info
            fetchAgentInfo();
            
            // Close menu when clicking outside
            window.onclick = function(event) {
                if (!event.target.matches('.panel-toggle') && !event.target.matches('#menu-btn')) {
                    var dropdowns = document.getElementsByClassName("dropdown-content");
                    for (var i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('shown')) {
                            openDropdown.classList.remove('shown');
                        }
                    }
                }
                
                // Close modal
                if (event.target == document.getElementById('details-modal')) {
                    closeModal();
                }
            }
        });
        
        async function fetchAgentInfo() {
            try {
                const res = await fetch('/api/agent/info');
                const data = await res.json();
                
                // Update Header Title
                if (data.chat_agent && data.chat_agent.model_name) {
                    const shortName = data.chat_agent.model_name.split('/').pop();
                    document.getElementById('agent-title').innerHTML = `Agent Manager <span style="font-weight: 400; font-size: 0.8em; opacity: 0.7;">(${shortName})</span>`;
                }
                
                // Store data for modal
                window.agentInfo = data;
                
                // Update Learning Toggle Text
                const learningToggle = document.getElementById('learning-toggle');
                if (data.learning_agent && data.learning_agent.enabled) {
                    const isRunning = data.learning_agent.running;
                    learningToggle.innerText = isRunning ? "‚è∏ Pause Learning" : "‚ñ∂ Resume Learning";
                    learningToggle.onclick = isRunning ? pauseLearning : resumeLearning;
                } else {
                    learningToggle.innerText = "üö´ Learning Unavailable";
                    learningToggle.style.opacity = "0.5";
                    learningToggle.onclick = null;
                }
                
            } catch(e) { console.error("Failed to fetch agent info", e); }
        }
        
        function toggleMenu() {
            document.getElementById("dropdown-menu").classList.toggle("shown");
        }
        
        function showAgentDetails() {
            const modal = document.getElementById('details-modal');
            modal.style.display = "block";
            toggleMenu(); // Close menu
            
            const data = window.agentInfo;
            if (!data) return;
            
            // Populate Chat Info
            const chatDiv = document.getElementById('chat-agent-info');
            chatDiv.innerHTML = `
                <div class="info-row"><span class="info-label">Model Name</span><span class="info-value">${data.chat_agent.model_name || 'Unknown'}</span></div>
                <div class="info-row"><span class="info-label">Device</span><span class="info-value">${data.chat_agent.device || 'Unknown'}</span></div>
                <div class="info-row"><span class="info-label">Context Length</span><span class="info-value">${(data.chat_agent.history_length || 0) * 2} turns</span></div>
                <div class="info-row"><span class="info-label">HF Token</span><span class="info-value">${data.chat_agent.has_token ? '‚úÖ Present' : '‚ùå Missing'}</span></div>
            `;
            
            // Populate Learning Info
            const learnDiv = document.getElementById('learning-agent-info');
            if (data.learning_agent.enabled) {
                 const l = data.learning_agent;
                 let stats = '';
                 if (l.total_steps) stats += `<div class="info-row"><span class="info-label">Total Steps</span><span class="info-value">${l.total_steps}</span></div>`;
                 if (l.total_episodes) stats += `<div class="info-row"><span class="info-label">Episodes</span><span class="info-value">${l.total_episodes}</span></div>`;
                 if (l.curiosity) stats += `<div class="info-row"><span class="info-label">Curiosity</span><span class="info-value">${(l.curiosity * 100).toFixed(1)}%</span></div>`;
                 
                 learnDiv.innerHTML = `
                    <div class="info-row"><span class="info-label">Status</span><span class="info-value" style="color: ${l.running ? '#00ff88' : '#ffaa00'}">${l.running ? 'Running' : 'Paused'}</span></div>
                    ${stats}
                 `;
            } else {
                learnDiv.innerHTML = '<div style="color: var(--text-dim); padding: 10px;">Autonomous learning is disabled or module not found.</div>';
            }
        }
        
        function closeModal() {
            document.getElementById('details-modal').style.display = "none";
        }
        
        async function clearHistory() {
            if(!confirm("Are you sure you want to clear the chat history?")) return;
            try {
                await fetch('/api/chat/history/clear', { method: 'POST' });
                document.getElementById('chatMessages').innerHTML = `
                    <div class="chat-message agent">
                        <div class="sender">Agent Manager</div>
                        <div class="bubble">Memory cleared. Ready for new task.</div>
                    </div>
                `;
                chatHistory = [];
                fetchAgentInfo(); // Refresh context length
            } catch(e) { alert("Failed to clear history"); }
            toggleMenu();
        }
        
        async function pauseLearning() {
            await fetch('/api/learning/pause', { method: 'POST' });
            fetchAgentInfo(); // Refresh status
            toggleMenu();
        }
        
        async function resumeLearning() {
            await fetch('/api/learning/resume', { method: 'POST' });
            fetchAgentInfo(); // Refresh status
            toggleMenu();
        }

        async function saveMemory() {
            if(!confirm("Save current session as RLDS episode?")) return;
            try {
                const res = await fetch('/api/memory/save', { method: 'POST' });
                const data = await res.json();
                alert(data.message || "Memory saved!");
            } catch(e) { alert("Failed to save memory: " + e); }
            toggleMenu();
        }

    </script>
    <script>
        // --- Web Audio API for Natural UX ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        function playStartListening() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playTone(880, 'sine', 0.1); // High beep
             setTimeout(() => playTone(1760, 'sine', 0.1), 150);
        }

        function playStopListening() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playTone(1760, 'sine', 0.1); 
            setTimeout(() => playTone(880, 'sine', 0.1), 150);
        }

        let isListening = false;
        function toggleVoice() {
            const btn = document.getElementById('micBtn');
            const placeholder = document.getElementById('chatInput');
            
            isListening = !isListening;
            
            if (isListening) {
                btn.classList.add('listening');
                playStartListening();
                placeholder.placeholder = "Listening...";
                // TODO: Wire up actual STT logic here
            } else {
                btn.classList.remove('listening');
                playStopListening();
                placeholder.placeholder = "Ask about tasks, control the robot, or chat with sub-agents...";
            }
        }
    </script>
</head>
<body>
    <div id="sidebar">
        <div class="logo">
            <span style="font-size: 1.2em;">üß†</span> Continuon<span>Brain</span>
        </div>
        
        <div style="flex: 1;">
            <a href="/ui/dashboard" target="main_frame" class="active" onclick="selectNav(this)">
                <span class="icon">üìä</span> Dashboard
            </a>
            <a href="/ui/tasks" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üìã</span> Task Library
            </a>
            <a href="/ui/manual" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üéÆ</span> Manual Control
            </a>
            <a href="/ui/status" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üîç</span> Brain Status
            </a>
            
            <!-- HOPE Monitoring Section -->
            <div style="margin: 20px 0; padding: 10px 24px; font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px;">
                HOPE Brain Development
            </div>
            <a href="/ui/hope/training" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üß†</span> Training Dashboard
            </a>
            <a href="/ui/hope/memory" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üíæ</span> CMS Memory
            </a>
            <a href="/ui/hope/stability" target="main_frame" onclick="selectNav(this)">
                <span class="icon">‚öñÔ∏è</span> Stability Monitor
            </a>
            <a href="/ui/hope/map" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üåå</span> Brain Map
            </a>
            <a href="/ui/hope/dynamics" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üåä</span> Wave-Particle
            </a>
            <a href="/ui/hope/performance" target="main_frame" onclick="selectNav(this)">
                <span class="icon">‚ö°</span> Performance
            </a>
            
            <div style="margin: 20px 0; padding: 10px 24px; font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px;">
                System
            </div>
            <a href="/ui/learning" target="main_frame" onclick="selectNav(this)">
                <span class="icon">üìä</span> Learning Dashboard
            </a>
            <a href="/ui/settings" target="main_frame" onclick="selectNav(this)">
                <span class="icon">‚öôÔ∏è</span> Settings
            </a>
        </div>
        
        <div class="sidebar-footer">
            <div><span class="status-dot"></span> System Online</div>
            <div style="margin-top: 8px; opacity: 0.6;">v2.0.0-alpha</div>
        </div>
    </div>
    
    <div id="main-area">
        <div id="content">
            <!-- Panel Toggle Buttons -->
            <button id="toggle-left" class="panel-toggle" onclick="toggleLeftPanel()" title="Toggle Navigation Panel">‚óÄ</button>
            <button id="toggle-right" class="panel-toggle" onclick="toggleRightPanel()" title="Toggle Chat Panel">‚ñ∂</button>
            <iframe name="main_frame" src="/ui/dashboard"></iframe>
        </div>
        
        <div id="chat-sidebar">
            <div class="chat-header">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>ü§ñ</span> <span id="agent-title">Agent Manager</span>
                    </div>
                    <button onclick="startNewSession()" 
                            style="background: rgba(0,255,136,0.1); border: 1px solid var(--accent-color); 
                                   color: var(--accent-color); padding: 4px 12px; border-radius: 4px; 
                                   cursor: pointer; font-size: 0.85em;"
                            title="Start a new conversation session">
                        New Session
                    </button>
                </div>
                <div style="flex: 1;"></div>
                <!-- Menu Button -->
                <div class="dropdown">
                    <button id="menu-btn" class="panel-toggle" style="position: static; width: 32px; height: 32px; font-size: 1em;" onclick="toggleMenu()">‚ãÆ</button>
                    <div id="dropdown-menu" class="dropdown-content">
                        <a onclick="showAgentDetails()">üìä Agent Details</a>
                        <a onclick="toggleLearning()" id="learning-toggle">‚è∏ Pause Learning</a>
                        <a onclick="saveMemory()">üíæ Save Memory (RLDS)</a>
                        <a onclick="clearHistory()" style="color: #ff5555;">üóë Clear History</a>
                    </div>
                </div>
                
                <!-- Agent Status Bar -->
                <div id="agent-status-bar" style="margin-top: 8px; padding: 6px 10px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 0.8em; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="agent-status-text" style="color: var(--accent-color);">‚óè Ready</span>
                        <span id="sub-agents-count" style="color: var(--text-dim); font-size: 0.85em;"></span>
                    </div>
                    <div id="agent-progress" style="margin-top: 4px; height: 2px; background: rgba(0,255,136,0.2); border-radius: 1px; overflow: hidden; display: none;">
                        <div style="height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s;" id="progress-bar"></div>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message agent">
                    <div class="sender">Agent Manager</div>
                    <div class="bubble">Hello! I'm the lead agent managing tasks and coordinating sub-agents. How can I help you today?</div>
                </div>
            </div>
            <!-- Intervention Prompt (hidden by default) -->
            <div id="intervention-prompt" style="display: none; padding: 16px; background: rgba(255,165,0,0.1); border-top: 2px solid #ffa500; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #ffa500;">ü§∑ I need your help deciding</div>
                <div id="intervention-question" style="margin-bottom: 12px; font-size: 0.9em;"></div>
                <div id="intervention-options" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
            </div>
            <div class="chat-input-area">
                <button id="micBtn" onclick="toggleVoice()" title="Voice Control">üéôÔ∏è</button>
                <textarea id="chatInput" placeholder="Ask about tasks, control the robot, or chat with sub-agents..."></textarea>
                <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
            
            <!-- Agent Details Modal -->
            <div id="details-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Agent System Status</h2>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <h3 style="margin-top: 0; font-size: 0.9em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px;">Chat Agent (Active)</h3>
                        <div id="chat-agent-info">Loading...</div>
                        
                        <h3 style="margin-top: 20px; font-size: 0.9em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px;">Learning Sub-Agent (HOPE)</h3>
                        <div id="learning-agent-info">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
