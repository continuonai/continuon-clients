<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContinuonBrain New UI</title>
    <link rel="stylesheet" href="/static/ui.css">
    <style>
        /* Base layout specific styles */
        .workspace-grid {
            display: grid;
            grid-template-columns: 320px 10px 1fr 10px 360px;
            height: calc(100vh - 48px);
            overflow: hidden;
        }

        .column {
            overflow-y: auto;
            background: #1e1e1e;
            height: 100%;
        }

        .col-resizer {
            width: 10px;
            background: #2d2d2d;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .col-resizer:hover {
            background: #007acc;
        }

        /* Navigation styles */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            border-bottom: 1px solid #333;
        }

        .nav-link {
            display: block;
            padding: 12px 16px;
            color: #ccc;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .nav-link:hover {
            background: #2d2d2d;
            color: #fff;
        }

        .nav-link.active {
            background: #007acc;
            color: #fff;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .workspace-grid {
                display: flex;
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }

            .col-resizer {
                display: none;
            }

            .column {
                width: 100% !important;
                height: auto;
                min-height: 300px;
            }

            .right-column {
                order: 3;
                /* Ensure chat is at the bottom or accessible */
                border-top: 1px solid #333;
            }
        }
    </style>
</head>

<body class="ide-body fullwidth">
    <div class="ide-shell wide">
        <header class="ide-topbar sticky">
            <div class="logo">ContinuonBrain</div>
            <div class="status-indicator" id="connection-status">Connected</div>
        </header>
        <div class="workspace-grid" id="workspace-grid">
            <!-- LEFT COLUMN: Navigation -->
            <section class="column left-column resizable" data-column="left">
                <nav>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="/"
                                class="nav-link ">Home / Status</a></li>
                        <li class="nav-item"><a href="/safety"
                                class="nav-link active">Operator & Safety</a>
                        </li>
                        <li class="nav-item"><a href="/tasks"
                                class="nav-link ">Autonomy Tasks</a>
                        </li>
                        <li class="nav-item"><a href="/skills"
                                class="nav-link ">Skill Library</a>
                        </li>
                        <li class="nav-item"><a href="/research"
                                class="nav-link ">Research & World
                                Model</a></li>
                        <li class="nav-item"><a href="/api_explorer"
                                class="nav-link ">API
                                Explorer</a></li>
                    </ul>
                </nav>
                <div class="panel">
                    <div class="panel-header">
                        <h2>System Info</h2>
                    </div>
                    <div class="panel-content">
                        <div id="system-info-content">Loading...</div>
                    </div>
                </div>
            </section>
            <div class="col-resizer" data-resize="left"></div>

            <!-- CENTER COLUMN: Content -->
            <main class="column center-column resizable" data-column="center">
                
<div class="panel">
    <div class="panel-header">
        <h2>Operator Controls</h2>
    </div>
    <div class="panel-content">
        <div class="control-group">
            <button class="btn danger" onclick="triggerEStop()">EMERGENCY STOP</button>
            <button class="btn warning" onclick="pauseRobot()">Pause</button>
            <button class="btn primary" onclick="resumeRobot()">Resume</button>
        </div>
        <div class="control-group" style="margin-top: 16px;">
            <button class="btn" onclick="window.location.href='/control'">Manual Control Interface</button>
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h2>Safety Gates</h2>
    </div>
    <div class="panel-content">
        <div id="safety-gates-list">
            <!-- Safety gates will be injected here -->
            <div class="loading-spinner">Loading safety gates...</div>
        </div>
    </div>
</div>

            </main>
            <div class="col-resizer" data-resize="right"></div>

            <!-- RIGHT COLUMN: Agent Chat Manager (Persistent) -->
            <aside class="column right-column resizable" data-column="right">
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <div class="panel-eyebrow">Continuon AI Agent Manager</div>
                            <h2>Threads & Guidance</h2>
                            <p class="panel-subtitle">Inline rail; no overlays for Flutter embed.</p>
                            <div id="persona-badge" class="persona-badge">Persona: default</div>
                        </div>
                        <div class="human-toggle" id="human-toggle" onclick="toggleHumanMode()">
                            <span>Human mode</span>
                            <strong id="human-toggle-state">Off</strong>
                        </div>
                    </div>
                    <div class="rail-actions">
                        <button class="rail-btn primary" onclick="resumeAgents()">‚ñ∂Ô∏è Resume agents</button>
                        <button class="rail-btn" onclick="pauseAgents()">‚è∏Ô∏è Pause agents</button>
                        <button class="rail-btn" onclick="reviewLearning()">üìí Review learning</button>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Active Agents</div>
                        <div class="agent-thread-list" id="agent-thread-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Model Stack & Fallbacks</div>
                        <div class="stack-list" id="model-stack-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Sub-agents & Tools</div>
                        <div class="stack-list" id="toolchain-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Training & Memories</div>
                        <div class="stack-list" id="training-memory-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Robot Mode Self-Learning</div>
                        <div class="milestone-list" id="learning-milestones"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Recent Learning Events</div>
                        <div class="learning-list" id="learning-events"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Agent Chat</div>
                        <div class="chat-rail">
                            <div class="chat-messages inline" id="chat-messages"></div>
                            <div class="chat-input-area inline">
                                <input type="text" class="chat-input" id="chat-input"
                                    placeholder="Ask about robot status, control tips..."
                                    aria-label="Chat message input"
                                    onkeypress="if(event.key==='Enter') sendChatMessage()">
                                <button class="chat-send-btn" id="chat-send" onclick="sendChatMessage()">‚û§</button>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <script src="/static/client.js"></script>
    <script src="/static/chat-overlay.js"></script>
    <script>
        // Initialize UI components
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize column resizers
            const grid = document.getElementById('workspace-grid');
            if (grid) {
                const leftHandle = document.querySelector('[data-resize="left"]');
                const rightHandle = document.querySelector('[data-resize="right"]');
                let leftWidth = 320;
                let rightWidth = 360;
                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
                const apply = () => {
                    if (window.innerWidth > 768) {
                        grid.style.gridTemplateColumns = `${leftWidth}px 10px 1fr 10px ${rightWidth}px`;
                    } else {
                        grid.style.gridTemplateColumns = '1fr';
                    }
                };

                // Initial apply
                apply();
                window.addEventListener('resize', apply);

                function startDrag(type) {
                    return function (event) {
                        event.preventDefault();
                        const startX = event.clientX;
                        const startLeft = leftWidth;
                        const startRight = rightWidth;
                        function onMove(e) {
                            const delta = e.clientX - startX;
                            if (type === 'left') {
                                leftWidth = clamp(startLeft + delta, 240, 520);
                            } else {
                                rightWidth = clamp(startRight - delta, 260, 520);
                            }
                            apply();
                        }
                        function onUp() {
                            document.removeEventListener('mousemove', onMove);
                            document.removeEventListener('mouseup', onUp);
                        }
                        document.addEventListener('mousemove', onMove);
                        document.addEventListener('mouseup', onUp);
                    };
                }

                leftHandle?.addEventListener('mousedown', startDrag('left'));
                rightHandle?.addEventListener('mousedown', startDrag('right'));
            }

            // Hydrate chat
            if (window.hydrateChatOverlay) {
                window.hydrateChatOverlay();
            }
        });
    </script>
</body>

</html>