{% extends "base.html" %}

{% block content %}
<div class="panel">
    <div class="panel-header">
        <h2>Training Control Center</h2>
        <div class="status-badge" id="training-status-badge">Unknown</div>
    </div>
    <div class="panel-content">
        <div class="panel-subtitle">
            <strong>Context:</strong> Training (learning systems, metrics, logs). Use the top-bar switcher to jump back to
            Inference/Operate. In hybrid autonomy (<code>autonomous</code>), inference runs while episodes record.
        </div>
        <div class="rail-actions">
            <button class="rail-btn primary" onclick="startAutonomousTraining()" title="POST /api/training/run">‚ñ∂ Run autonomous training job</button>
            <button class="rail-btn" onclick="startManualTraining()" title="POST /api/training/manual">üõ† Run one manual training step</button>
            <button class="rail-btn input-warn" onclick="testManualTraining()" title="POST /api/training/manual (dry run)">üß™ Test training (dry run)</button>
            <button class="rail-btn" onclick="stopTraining()" title="Stops the current trainer job if supported">‚èπ Stop trainer</button>
        </div>
        <div style="margin-top: 15px;">
            <h3>WaveCore Loops</h3>
            <div class="rail-actions">
                <button class="rail-btn" onclick="runWaveCoreLoop('fast')" title="POST /api/training/wavecore_loops (fast)">‚ö° Run WaveCore fast loop</button>
                <button class="rail-btn" onclick="runWaveCoreLoop('mid')" title="POST /api/training/wavecore_loops (mid)">üåä Run WaveCore mid loop</button>
                <button class="rail-btn" onclick="runWaveCoreLoop('slow')" title="POST /api/training/wavecore_loops (slow)">üê¢ Run WaveCore slow loop</button>
            </div>
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h2>Agent Chat Learning Tests</h2>
        <div class="status-badge" id="chat-learn-status">Ready</div>
    </div>
    <div class="panel-content">
        <div class="panel-subtitle">
            Test multi-turn agentic learning conversations between Agent Manager and subagents. 
            Generates RLDS training data when logging is enabled.
        </div>
        
        <!-- Quick Tests -->
        <div style="margin-top: 15px;">
            <h3>Quick Tests</h3>
            <div class="rail-actions">
                <button class="rail-btn primary" onclick="runChatLearnTest('basic')" 
                    title="HOPE agent manager only">üß† Basic HOPE</button>
                <button class="rail-btn" onclick="runChatLearnTest('hope-gemma')" 
                    title="HOPE with Gemma subagent">ü§ù HOPE + Gemma</button>
                <button class="rail-btn" onclick="runChatLearnTest('jax')" 
                    title="JAX integration test">‚ö° JAX Test</button>
            </div>
        </div>
        
        <!-- Extended Tests -->
        <div style="margin-top: 15px;">
            <h3>Extended Tests</h3>
            <div class="rail-actions">
                <button class="rail-btn" onclick="runChatLearnTest('extended')" 
                    title="10-turn extended conversation">üìö Extended (10 turns)</button>
                <button class="rail-btn" onclick="runChatLearnTest('multi-topic')" 
                    title="Multiple topics">üåê Multi-Topic</button>
            </div>
        </div>
        
        <!-- Custom Test -->
        <div style="margin-top: 15px;">
            <h3>Custom Test</h3>
            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                <label class="input-group">
                    Turns
                    <input type="number" id="chat-learn-turns" min="1" max="50" value="5">
                </label>
                <label class="input-group">
                    Model
                    <select id="chat-learn-model">
                        <option value="hope-v1">HOPE v1</option>
                        <option value="google/gemma-3n-2b">Gemma 3n 2B</option>
                        <option value="google/gemma-2-2b-it">Gemma 2 2B IT</option>
                        <option value="google/gemma-3-270m-it">Gemma 3 270M IT</option>
                        <option value="google/gemma-3n-E2B-it">Gemma 3n E2B IT</option>
                        <option value="TinyLlama/TinyLlama-1.1B-Chat-v1.0">TinyLlama 1.1B Chat</option>
                        <option value="google/gemma-370m">Gemma 370M (legacy)</option>
                    </select>
                </label>
                <label class="input-group">
                    Delegate Model
                    <select id="chat-learn-delegate">
                        <option value="">None</option>
                        <option value="google/gemma-3-270m-it">Gemma 3 270M IT</option>
                        <option value="google/gemma-2-2b-it">Gemma 2 2B IT</option>
                        <option value="google/gemma-3n-2b">Gemma 3n 2B</option>
                        <option value="TinyLlama/TinyLlama-1.1B-Chat-v1.0">TinyLlama 1.1B Chat</option>
                        <option value="google/gemma-370m">Gemma 370M (legacy)</option>
                        <option value="consult:google/gemma-3-270m-it">Consult: Gemma 3 270M</option>
                        <option value="consult:google/gemma-2-2b-it">Consult: Gemma 2 2B</option>
                    </select>
                </label>
                <label class="input-group" style="grid-column: span 2;">
                    Topic
                    <input type="text" id="chat-learn-topic" 
                        placeholder="tool use + planning + safety" 
                        value="JAX training pipeline and multi-turn learning">
                </label>
            </div>
            <div class="rail-actions" style="margin-top: 10px;">
                <button class="rail-btn primary" onclick="runChatLearnCustom()">‚ñ∂ Run Custom Test</button>
                <button class="rail-btn" onclick="checkChatLearnRLDS()">üìä Check RLDS Status</button>
            </div>
        </div>
        
        <!-- Results Display -->
        <div style="margin-top: 15px;">
            <h3>Test Results</h3>
            <div id="chat-learn-results" style="background: #0a0a0a; color: #0f0; border-radius: 4px; padding: 10px; font-family: monospace; max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 12px;">
                No tests run yet. Click a test button above to start.
            </div>
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h2>Real-time Metrics</h2>
        <button class="rail-btn" onclick="refreshMetrics()">‚Üª Refresh</button>
    </div>
    <div class="panel-content">
        <div class="status-grid" id="metrics-grid">
            <div class="status-item">
                <label>State</label>
                <span id="trainer-state">--</span>
            </div>
            <div class="status-item">
                <label>Steps</label>
                <span id="metric-steps">--</span>
            </div>
            <div class="status-item">
                <label>Avg Loss</label>
                <span id="metric-loss">--</span>
            </div>
            <div class="status-item">
                <label>Adapter Path</label>
                <span id="adapter-path">--</span>
            </div>
        </div>
        <div id="full-metrics-json"
            style="margin-top: 20px; white-space: pre-wrap; font-family: monospace; background: #111; padding: 10px; border-radius: 4px; display: none;">
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Seed Model Loop</h2>
            <div class="stack-meta">Deliberate, reiterative path from local episodes ‚Üí small HF corpora ‚Üí edge/export bundle.</div>
        </div>
        <div class="status-badge" id="seed-iteration-chip">Staging‚Ä¶</div>
    </div>
    <div class="panel-content">
        <div class="panel-subtitle">Iterative steps (repeatable)</div>
        <div class="stack" id="seed-iteration-plan">
            <div class="stack-item"><span class="stack-meta">Loading plan‚Ä¶</span></div>
        </div>
        <div class="panel-subtitle" style="margin-top: 14px;">Small HF datasets to blend</div>
        <div class="stack-meta">Use compact corpora to prime the seed before replaying RLDS episodes. Keep merges auditable.</div>
        <ul class="stack-meta" style="margin-top: 6px;">
            <li><strong>VLM:</strong> <a href="https://huggingface.co/datasets/liuhaotian/LLaVA-Instruct-150K" target="_blank" rel="noreferrer">liuhaotian/LLaVA-Instruct-150K</a> (instruction-following image/text pairs)</li>
            <li><strong>VLA (actions):</strong> <a href="https://huggingface.co/datasets/Open-X-Embodiment/bridge_data_v2" target="_blank" rel="noreferrer">Open-X-Embodiment/bridge_data_v2</a> (robot demo trajectories; subsample for Pi)</li>
            <li><strong>LM (grounding text):</strong> <a href="https://huggingface.co/datasets/HuggingFaceH4/ultrachat_200k" target="_blank" rel="noreferrer">HuggingFaceH4/ultrachat_200k</a> (chat-style language scaffold)</li>
        </ul>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div>
            <h2>Seed Bundle</h2>
            <div class="stack-meta">Offline-first export/install helpers for cloud or edge handoffs.</div>
        </div>
        <div class="status-badge" id="seed-readiness-chip">Checking‚Ä¶</div>
    </div>
    <div class="panel-content">
        <div class="stack" id="seed-readiness-gates">
            <div class="stack-item"><span class="stack-meta">Running readiness check‚Ä¶</span></div>
        </div>
        <div class="stack-meta" id="seed-readiness-meta"></div>

        <div class="panel-subtitle" style="margin-top: 16px;">Export seed bundle</div>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px;">
            <label class="input-group"><input type="checkbox" id="cloud-export-episodes" checked> Episodes (RLDS)</label>
            <label class="input-group"><input type="checkbox" id="cloud-export-seed" checked> Seed export</label>
            <label class="input-group"><input type="checkbox" id="cloud-export-checkpoints" checked> Checkpoints</label>
            <label class="input-group"><input type="checkbox" id="cloud-export-tfrecord"> TFRecord cache</label>
            <label class="input-group" style="grid-column: span 2;">
                Export name
                <input id="seed-export-name" type="text" placeholder="cloud_handoff_2024-01-15.zip">
            </label>
            <label class="input-group" style="grid-column: span 2;">
                Episode limit (optional)
                <input id="cloud-export-episode-limit" type="number" min="1" placeholder="All recent episodes">
            </label>
        </div>
        <div class="rail-actions" style="margin-top: 10px;">
            <button class="rail-btn" onclick="buildSeedExportZip()">‚¨á Build export zip</button>
            <button class="rail-btn" onclick="listSeedExports()">‚Üª Refresh exports</button>
        </div>
        <div class="stack-meta" id="cloud-export-status"></div>
        <div class="stack" id="cloud-export-list"></div>

        <div class="panel-subtitle" style="margin-top: 18px;">Install bundle</div>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px;">
            <label class="input-group">
                Kind
                <select id="cloud-install-kind">
                    <option value="jax_seed_manifest">JAX seed manifest</option>
                    <option value="edge_bundle">Edge bundle (edge_manifest.json)</option>
                    <option value="vertex_edge">Vertex Edge (auto-detect)</option>
                </select>
            </label>
            <label class="input-group">
                Source URL
                <input id="cloud-install-url" type="url" placeholder="https://.../bundle.zip" aria-describedby="cloud-install-url-help">
                <span id="cloud-install-url-help" class="input-help">Requires readiness</span>
            </label>
            <label class="input-group">
                Local path
                <input id="cloud-install-path" type="text" placeholder="/opt/continuonos/brain/exports/my_bundle.zip">
            </label>
            <label class="input-group">
                Path helper (pi5 defaults)
                <select id="seed-path-helper" onchange="applySeedPathHelper(this.value)">
                    <option value="">Select a helper‚Ä¶</option>
                    <option value="candidate-manifest">Candidate seed manifest (core_model_seed)</option>
                    <option value="default-manifest">Example manifest (pi5)</option>
                    <option value="adapter-dir">Current adapter dir (pi5)</option>
                </select>
            </label>
        </div>
        <div class="rail-actions" style="margin-top: 10px;">
            <button class="rail-btn primary" onclick="installSeedBundle()">‚¨Ü Install bundle</button>
            <button class="rail-btn" onclick="refreshSeedReadiness()">‚Üª Re-run readiness</button>
        </div>
        <div class="stack-meta" id="cloud-install-status"></div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h2>Training Logs</h2>
        <button class="rail-btn" onclick="refreshLogs()">‚Üª Refresh Logs</button>
    </div>
    <div class="panel-content">
        <div style="display: flex; gap: 10px; align-items: stretch;">
            <div id="training-log-list" style="width: 260px; max-width: 50%; background: #0a0a0a; color: #0f0; border-radius: 4px; padding: 8px; font-family: monospace; overflow-y: auto; max-height: 320px;">
                Loading log list...
            </div>
            <pre id="training-logs"
                style="flex: 1; height: 300px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace;">Waiting for logs...</pre>
        </div>
    </div>
</div>

<script src="/static/training.js?v=test3"></script>
{% endblock %}