<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Continuon Brain{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           CONTINUON BRAIN UI v2.0 - Command Center
           ============================================ */
        
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Background */
            --bg-deep: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a24;
            --bg-glass: rgba(255,255,255,0.03);
            --bg-glass-hover: rgba(255,255,255,0.06);
            
            /* Accent */
            --accent-primary: #6366f1;
            --accent-primary-dim: rgba(99, 102, 241, 0.15);
            --accent-success: #10b981;
            --accent-success-dim: rgba(16, 185, 129, 0.15);
            --accent-warning: #f59e0b;
            --accent-warning-dim: rgba(245, 158, 11, 0.15);
            --accent-danger: #ef4444;
            --accent-danger-dim: rgba(239, 68, 68, 0.15);
            --accent-info: #3b82f6;
            
            /* RCAN Roles */
            --role-creator: #a855f7;
            --role-owner: #6366f1;
            --role-leasee: #14b8a6;
            --role-user: #3b82f6;
            --role-guest: #64748b;
            
            /* Modes */
            --mode-autonomous: #10b981;
            --mode-manual: #f59e0b;
            --mode-training: #6366f1;
            --mode-idle: #64748b;
            --mode-emergency: #ef4444;
            
            /* Text */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            /* Borders */
            --border-subtle: rgba(255,255,255,0.06);
            --border-default: rgba(255,255,255,0.1);
            --border-focus: var(--accent-primary);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            
            /* Fonts */
            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-display: 'Space Grotesk', sans-serif;
            
            /* Animation */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --duration-slow: 400ms;
            
            /* Layout */
            --nav-width: 72px;
            --agent-width: 360px;
            --header-height: 56px;
            --footer-height: 32px;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-ui);
            background: var(--bg-deep);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ============================================
           LAYOUT STRUCTURE
           ============================================ */
        
        .app-shell {
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--footer-height);
            grid-template-columns: var(--nav-width) 1fr var(--agent-width);
            height: 100vh;
            gap: 0;
        }

        /* Header spans full width */
        .app-header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 100;
        }

        /* Nav rail on left */
        .nav-rail {
            grid-row: 2;
            grid-column: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-subtle);
            gap: 4px;
        }

        /* Main workspace in center */
        .workspace {
            grid-row: 2;
            grid-column: 2;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-deep);
        }

        /* Agent rail on right */
        .agent-rail {
            grid-row: 2;
            grid-column: 3;
            display: flex;
            flex-direction: column;
            background: var(--bg-surface);
            border-left: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        /* Footer spans full width */
        .app-footer {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-surface);
            border-top: 1px solid var(--border-subtle);
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ============================================
           HEADER COMPONENTS
           ============================================ */
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .robot-identity {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .robot-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-primary), var(--role-creator));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .robot-info {
            display: flex;
            flex-direction: column;
        }

        .robot-name {
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background var(--duration-fast);
        }
        
        .robot-name:hover {
            background: var(--bg-glass-hover);
        }
        
        .robot-name.editing {
            background: var(--bg-elevated);
            outline: 1px solid var(--accent-primary);
        }

        .robot-ruri {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
        }
        
        .creator-name {
            font-size: 9px;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-switcher {
            display: flex;
            background: var(--bg-glass);
            border-radius: 8px;
            padding: 4px;
            gap: 2px;
        }

        .mode-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out-expo);
        }

        .mode-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .mode-btn.active[data-mode="autonomous"] { background: var(--mode-autonomous); }
        .mode-btn.active[data-mode="manual"] { background: var(--mode-manual); }
        .mode-btn.active[data-mode="training"] { background: var(--mode-training); }
        .mode-btn.active[data-mode="idle"] { background: var(--mode-idle); }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-glass);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.success { background: var(--accent-success); }
        .status-dot.warning { background: var(--accent-warning); }
        .status-dot.danger { background: var(--accent-danger); }
        .status-dot.info { background: var(--accent-info); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .safety-btn {
            padding: 6px 12px;
            border: 1px solid var(--accent-danger);
            background: var(--accent-danger-dim);
            color: var(--accent-danger);
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--duration-fast);
        }

        .safety-btn:hover {
            background: var(--accent-danger);
            color: white;
        }

        /* ============================================
           NAV RAIL
           ============================================ */
        
        .nav-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out-expo);
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: var(--accent-primary);
            border-radius: 0 2px 2px 0;
        }

        .nav-divider {
            width: 32px;
            height: 1px;
            background: var(--border-subtle);
            margin: 8px 0;
        }

        .nav-spacer {
            flex: 1;
        }

        /* ============================================
           WORKSPACE
           ============================================ */
        
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .grid-auto { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }

        /* Cards */
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            transition: all var(--duration-fast);
        }

        .card:hover {
            border-color: var(--border-default);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .card-value {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Metric cards */
        .metric-card {
            display: flex;
            flex-direction: column;
        }

        .metric-card .icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .metric-card .icon.primary { background: var(--accent-primary-dim); }
        .metric-card .icon.success { background: var(--accent-success-dim); }
        .metric-card .icon.warning { background: var(--accent-warning-dim); }
        .metric-card .icon.danger { background: var(--accent-danger-dim); }

        /* ============================================
           AGENT RAIL (Chat)
           ============================================ */
        
        .agent-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .agent-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 600;
        }

        .agent-status {
            font-size: 11px;
            color: var(--text-muted);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--accent-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.agent {
            align-self: flex-start;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
            transition: border-color var(--duration-fast);
        }

        .chat-input:focus {
            border-color: var(--accent-primary);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-send {
            padding: 10px 16px;
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-fast);
        }

        .chat-send:hover {
            filter: brightness(1.1);
        }

        .chat-mic {
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--duration-fast);
            font-size: 16px;
        }

        .chat-mic:hover {
            background: var(--bg-glass-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .chat-mic.recording {
            background: var(--accent-danger-dim);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ============================================
           FOOTER
           ============================================ */
        
        .footer-left, .footer-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .footer-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .footer-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        
        @media (max-width: 1200px) {
            :root {
                --agent-width: 300px;
            }
        }

        @media (max-width: 900px) {
            .app-shell {
                grid-template-columns: var(--nav-width) 1fr;
            }
            
            .agent-rail {
                display: none;
            }
            
            .header-center {
                display: none;
            }
        }

        @media (max-width: 600px) {
            :root {
                --nav-width: 56px;
                --header-height: 48px;
            }
            
            .robot-info {
                display: none;
            }
            
            .header-right .status-chip:not(:first-child) {
                display: none;
            }
        }

        /* ============================================
           UTILITIES
           ============================================ */
        
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--accent-success); }
        .text-warning { color: var(--accent-warning); }
        .text-danger { color: var(--accent-danger); }
        
        .bg-success { background: var(--accent-success); }
        .bg-warning { background: var(--accent-warning); }
        .bg-danger { background: var(--accent-danger); }
        
        .font-mono { font-family: var(--font-mono); }
        .font-display { font-family: var(--font-display); }
        
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }

        /* ============================================
           TOOLTIPS & HELP
           ============================================ */

        /* Custom tooltip for nav items */
        .nav-item {
            position: relative;
        }

        .nav-item::after {
            content: attr(title);
            position: absolute;
            left: calc(100% + 12px);
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--duration-fast);
            z-index: 1000;
            box-shadow: var(--shadow-md);
            pointer-events: none;
        }

        .nav-item:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Info badges for help */
        .info-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            font-size: 10px;
            color: var(--text-muted);
            cursor: help;
            margin-left: 6px;
        }

        .info-badge:hover {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Help text under sections */
        .help-text {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        /* Status indicator badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.online {
            background: var(--accent-success-dim);
            color: var(--accent-success);
        }

        .status-badge.offline {
            background: var(--accent-danger-dim);
            color: var(--accent-danger);
        }

        .status-badge.pending {
            background: var(--accent-warning-dim);
            color: var(--accent-warning);
        }

        {% block extra_styles %}{% endblock %}
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-left">
                <div class="robot-identity">
                    <div class="robot-avatar">ü§ñ</div>
                    <div class="robot-info">
                        <div class="robot-name" id="robot-name" contenteditable="false" 
                             onclick="editRobotName()" onblur="saveRobotName()" 
                             onkeydown="handleNameKey(event)" title="Click to edit robot name">Loading...</div>
                        <div class="robot-ruri" id="robot-ruri">rcan://...</div>
                        <div class="creator-name" id="creator-name"></div>
                    </div>
                </div>
            </div>
            
            <div class="header-center">
                <div class="mode-switcher">
                    <button class="mode-btn" data-mode="autonomous" onclick="setMode('autonomous')">Autonomous</button>
                    <button class="mode-btn" data-mode="manual" onclick="setMode('manual_control')">Manual</button>
                    <button class="mode-btn" data-mode="training" onclick="setMode('sleep_learning')">Training</button>
                    <button class="mode-btn" data-mode="idle" onclick="setMode('idle')">Idle</button>
                </div>
            </div>
            
            <div class="header-right">
                <div class="status-chip">
                    <span class="status-dot success" id="api-status-dot"></span>
                    <span id="api-status">Connected</span>
                </div>
                <div class="status-chip">
                    <span id="rcan-sessions">0 sessions</span>
                </div>
                <button class="safety-btn" onclick="triggerSafetyHold()">‚ö†Ô∏è SAFETY HOLD</button>
            </div>
        </header>

        <!-- NAV RAIL -->
        <nav class="nav-rail" role="navigation" aria-label="Main navigation">
            <button class="nav-item{% if active_page == 'dashboard' %} active{% endif %}" data-page="dashboard" onclick="navigateTo('dashboard')" title="Dashboard - System overview and status" aria-label="Dashboard">üè†</button>
            <button class="nav-item{% if active_page == 'control' %} active{% endif %}" data-page="control" onclick="navigateTo('control')" title="Control - Manual robot control & camera" aria-label="Control Center">üéÆ</button>
            <button class="nav-item{% if active_page == 'training' %} active{% endif %}" data-page="training" onclick="navigateTo('training')" title="Training - ML pipeline & teacher mode" aria-label="Training Hub">üß†</button>
            <button class="nav-item{% if active_page == 'safety' %} active{% endif %}" data-page="safety" onclick="navigateTo('safety')" title="Safety - Ring 0 kernel & work authorization" aria-label="Safety Center">üõ°Ô∏è</button>
            <div class="nav-divider" role="separator"></div>
            <button class="nav-item{% if active_page == 'network' %} active{% endif %}" data-page="network" onclick="navigateTo('network')" title="Network - RCAN, WiFi & Bluetooth" aria-label="Network Settings">üì°</button>
            <button class="nav-item{% if active_page == 'agent' %} active{% endif %}" data-page="agent" onclick="navigateTo('agent')" title="Agent - Chat with HOPE AI assistant" aria-label="Agent Chat">üí¨</button>
            <button class="nav-item{% if active_page == 'connect' %} active{% endif %}" data-page="connect" onclick="navigateTo('connect')" title="Find My Robot - Scan QR code to connect" aria-label="Find Robot">üîç</button>
            <div class="nav-spacer"></div>
            <div class="nav-divider" role="separator"></div>
            <button class="nav-item{% if active_page == 'settings' %} active{% endif %}" data-page="settings" onclick="navigateTo('settings')" title="Settings - System configuration" aria-label="Settings">‚öôÔ∏è</button>
        </nav>

        <!-- MAIN WORKSPACE -->
        <main class="workspace">
            {% block content %}{% endblock %}
        </main>

        <!-- AGENT RAIL -->
        <aside class="agent-rail">
            <div class="agent-header">
                <div class="agent-title">HOPE Agent</div>
                <div class="agent-status" id="agent-status">Ready</div>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message agent">Hello! I'm HOPE, your robot companion. How can I help you today?</div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Message HOPE..."
                               onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="chat-mic" id="chat-mic" title="Voice input (hold to talk)">üé§</button>
                        <button class="chat-send" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- FOOTER -->
        <footer class="app-footer">
            <div class="footer-left">
                <div class="footer-item">
                    <span class="footer-dot bg-success"></span>
                    <span>Safety Kernel OK</span>
                </div>
                <div class="footer-item">
                    <span id="memory-usage">RAM: --</span>
                </div>
                <div class="footer-item">
                    <span id="uptime">Uptime: --</span>
                </div>
            </div>
            <div class="footer-right">
                <div class="footer-item">
                    <span id="inference-rate">Inference: -- Hz</span>
                </div>
                <div class="footer-item font-mono">
                    v4.2.0 | Seed Model
                </div>
            </div>
        </footer>
    </div>

    <!-- Real-time WebSocket/SSE client for live data -->
    <script src="/static/realtime.js"></script>

    <script>
        // ============================================
        // CORE APP LOGIC
        // ============================================

        let currentPage = '{{ active_page|default("dashboard") }}';
        let robotState = {};
        
        // Navigation - use clean routes
        function navigateTo(page) {
            currentPage = page;
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === page);
            });
            // Navigate to clean routes (server supports both / and /v2/ prefixes)
            const route = page === 'dashboard' ? '/' : '/' + page;
            window.location.href = route;
        }
        
        // Mode switching
        async function setMode(mode) {
            try {
                const response = await fetch(`/api/mode/${mode}`, { method: 'POST' });
                const data = await response.json();
                updateModeUI(data.mode || mode);
            } catch (error) {
                console.error('Mode switch failed:', error);
            }
        }
        
        function updateModeUI(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                const btnMode = btn.dataset.mode;
                const isActive = mode.includes(btnMode) || 
                                (btnMode === 'training' && mode === 'sleep_learning') ||
                                (btnMode === 'manual' && mode === 'manual_control');
                btn.classList.toggle('active', isActive);
            });
        }
        
        // Safety
        async function triggerSafetyHold() {
            if (confirm('Trigger safety hold? This will stop all motion.')) {
                try {
                    await fetch('/api/safety/hold', { method: 'POST' });
                    alert('Safety hold activated');
                } catch (error) {
                    console.error('Safety hold failed:', error);
                }
            }
        }
        
        // Chat
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Send to API
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                const reply = data.response || data.message || 'No response';
                messagesDiv.innerHTML += `<div class="chat-message agent">${escapeHtml(reply)}</div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                messagesDiv.innerHTML += `<div class="chat-message agent text-danger">Error: ${error.message}</div>`;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Status polling
        async function fetchStatus() {
            try {
                const [statusRes, rcanRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/rcan/v1/status')
                ]);
                
                const status = await statusRes.json();
                const rcan = await rcanRes.json();
                
                robotState = { ...status, rcan };
                updateUI(status, rcan);
            } catch (error) {
                document.getElementById('api-status').textContent = 'Disconnected';
                document.getElementById('api-status-dot').className = 'status-dot danger';
            }
        }
        
        function updateUI(status, rcan) {
            // API status
            document.getElementById('api-status').textContent = status.api_state === 'ok' ? 'Connected' : 'Error';
            document.getElementById('api-status-dot').className = 'status-dot ' + (status.api_state === 'ok' ? 'success' : 'danger');
            
            // Mode
            updateModeUI(status.mode || 'idle');
            
            // RCAN
            if (rcan && rcan.ruri) {
                document.getElementById('robot-ruri').textContent = rcan.ruri;
                document.getElementById('rcan-sessions').textContent = `${rcan.active_sessions || 0} sessions`;
            }
            
            // Loop metrics
            if (status.loop_metrics && status.loop_metrics.hope_loops) {
                const fast = status.loop_metrics.hope_loops.fast;
                if (fast) {
                    document.getElementById('inference-rate').textContent = `Inference: ${fast.hz} Hz`;
                }
            }
            
            // Memory (from runtime_context)
            if (status.runtime_context && status.runtime_context.hardware && status.runtime_context.hardware.system) {
                const sys = status.runtime_context.hardware.system;
                document.getElementById('memory-usage').textContent = 
                    `RAM: ${sys.ram_available_gb?.toFixed(1) || '--'}GB / ${sys.ram_total_gb?.toFixed(1) || '--'}GB`;
            }
            
            // Uptime
            if (status.runtime_context && status.runtime_context.uptime_seconds) {
                const uptime = Math.floor(status.runtime_context.uptime_seconds);
                const hours = Math.floor(uptime / 3600);
                const mins = Math.floor((uptime % 3600) / 60);
                document.getElementById('uptime').textContent = `Uptime: ${hours}h ${mins}m`;
            }
        }
        
        // Discovery
        async function fetchDiscovery() {
            try {
                const response = await fetch('/api/discovery/info');
                const data = await response.json();
                document.getElementById('robot-name').textContent = data.robot_name || 'ContinuonBot';
                // Creator name removed from display
                if (data.rcan && data.rcan.ruri) {
                    document.getElementById('robot-ruri').textContent = data.rcan.ruri;
                }
            } catch (error) {
                console.error('Discovery failed:', error);
            }
        }
        
        // Robot Name Editing (owners only)
        let originalRobotName = '';
        
        function editRobotName() {
            const el = document.getElementById('robot-name');
            originalRobotName = el.textContent;
            el.contentEditable = 'true';
            el.classList.add('editing');
            el.focus();
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(el);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
        
        function handleNameKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveRobotName();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelNameEdit();
            }
        }
        
        function cancelNameEdit() {
            const el = document.getElementById('robot-name');
            el.textContent = originalRobotName;
            el.contentEditable = 'false';
            el.classList.remove('editing');
        }
        
        async function saveRobotName() {
            const el = document.getElementById('robot-name');
            const newName = el.textContent.trim();
            el.contentEditable = 'false';
            el.classList.remove('editing');
            
            if (!newName || newName === originalRobotName) {
                el.textContent = originalRobotName || 'ContinuonBot';
                return;
            }
            
            try {
                const response = await fetch('/api/robot/name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ robot_name: newName })
                });
                const data = await response.json();
                if (data.success) {
                    el.textContent = data.robot_name;
                    originalRobotName = data.robot_name;
                } else {
                    alert('Failed to save robot name: ' + (data.error || 'Unknown error'));
                    el.textContent = originalRobotName;
                }
            } catch (error) {
                console.error('Save robot name failed:', error);
                el.textContent = originalRobotName;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchDiscovery();

            // Use realtime client for live updates if available
            if (typeof realtimeClient !== 'undefined') {
                // Subscribe to channels
                realtimeClient.subscribe(['status', 'loops', 'cognitive']);

                // Handle real-time status updates
                realtimeClient.on('status', (data) => {
                    robotState = data;
                    updateStatusUI(data);
                });

                // Handle loop metrics
                realtimeClient.on('loops', (data) => {
                    if (data && data.loops) {
                        // Update loop health indicators if present
                        const loopData = data.loops;
                        if (document.getElementById('inference-rate') && loopData.mid_loop) {
                            document.getElementById('inference-rate').textContent =
                                `Inference: ${(loopData.mid_loop.hz || 0).toFixed(1)} Hz`;
                        }
                    }
                });

                // Handle cognitive events (thoughts, tool use, etc.)
                realtimeClient.on('cognitive', (data) => {
                    console.log('Cognitive event:', data);
                    // Could update UI with reasoning traces here
                });

                // Connection status indicator
                realtimeClient.on('connected', (info) => {
                    console.log('Real-time connected via', info.type);
                    document.querySelector('.footer-dot')?.classList.add('bg-success');
                });

                realtimeClient.on('disconnected', () => {
                    console.log('Real-time disconnected');
                    document.querySelector('.footer-dot')?.classList.remove('bg-success');
                });

                // Fallback: still do initial fetch
                fetchStatus();
            } else {
                // Fallback to polling if realtime client not available
                fetchStatus();
                setInterval(fetchStatus, 2000);
            }
        });
        
        {% block extra_scripts %}{% endblock %}
    </script>
</body>
</html>

