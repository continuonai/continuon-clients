<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0c111b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/brain-icon.svg">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <title>ContinuonBrain New UI</title>
    <link rel="stylesheet" href="/static/ui.css">
    <style>
        /* Base layout specific styles */
        .workspace-grid {
            display: grid;
            grid-template-columns: 320px 10px 1fr 10px 360px;
            height: calc(100vh - 48px);
            overflow: hidden;
        }

        .column {
            overflow-y: auto;
            background: #1e1e1e;
            height: 100%;
        }

        .col-resizer {
            width: 10px;
            background: #2d2d2d;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .col-resizer:hover {
            background: #007acc;
        }

        /* Navigation styles */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            border-bottom: 1px solid #333;
        }

        .nav-link {
            display: block;
            padding: 12px 16px;
            color: #ccc;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .nav-link:hover {
            background: #2d2d2d;
            color: #fff;
        }

        .nav-link.active {
            background: #007acc;
            color: #fff;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .workspace-grid {
                display: flex;
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }

            .col-resizer {
                display: none;
            }

            .column {
                width: 100% !important;
                height: auto;
                min-height: 300px;
            }

            .right-column {
                order: 3;
                /* Ensure chat is at the bottom or accessible */
                border-top: 1px solid #333;
            }
        }
    </style>
</head>

<body class="ide-body fullwidth">
    <div class="ide-shell wide">
        <header class="ide-topbar sticky">
            <div class="logo">ContinuonBrain</div>
            <div class="status-indicator" id="connection-status">Connected</div>
        </header>
        <div class="mobile-top-actions" id="mobile-actions" aria-live="polite">
            <div class="mobile-action-row">
                <div class="mobile-chip" id="mobile-status-chip">Loading robot status‚Ä¶</div>
                <div class="mobile-chip ghost" id="mobile-health-chip">Health checks pending</div>
            </div>
            <div class="mobile-action-row">
                <button class="mobile-action-btn" id="mobile-refresh" type="button">Refresh status</button>
                <button class="mobile-action-btn ghost" id="mobile-rail-toggle" type="button">Hide agent rail</button>
                <span class="mobile-action-hint">Prefer the Continuon AI app? Point it at this robot to use the mobile summary endpoint.</span>
            </div>
        </div>
        <div class="workspace-grid" id="workspace-grid">
            <!-- LEFT COLUMN: Navigation -->
            <section class="column left-column resizable" data-column="left">
                <nav>
                    <ul class="nav-list">
                        <li class="nav-item"><a href="/"
                                class="nav-link {% if active_page == 'home' %}active{% endif %}">Home / Status</a></li>
                        <li class="nav-item"><a href="/safety"
                                class="nav-link {% if active_page == 'safety' %}active{% endif %}">Operator & Safety</a>
                        </li>
                        <li class="nav-item"><a href="/tasks"
                                class="nav-link {% if active_page == 'tasks' %}active{% endif %}">Autonomy Tasks</a>
                        </li>
                        <li class="nav-item"><a href="/skills"
                                class="nav-link {% if active_page == 'skills' %}active{% endif %}">Skill Library</a>
                        </li>
                        <li class="nav-item"><a href="/research"
                                class="nav-link {% if active_page == 'research' %}active{% endif %}">Research & World
                                Model</a></li>
                        <li class="nav-item"><a href="/api_explorer"
                                class="nav-link {% if active_page == 'api_explorer' %}active{% endif %}">API
                                Explorer</a></li>
                    </ul>
                </nav>
                <div class="panel">
                    <div class="panel-header">
                        <h2>System Info</h2>
                    </div>
                    <div class="panel-content">
                        <div id="system-info-content">Loading...</div>
                    </div>
                </div>
            </section>
            <div class="col-resizer" data-resize="left"></div>

            <!-- CENTER COLUMN: Content -->
            <main class="column center-column resizable" data-column="center">
                {% block content %}{% endblock %}
            </main>
            <div class="col-resizer" data-resize="right"></div>

            <!-- RIGHT COLUMN: Agent Chat Manager (Persistent) -->
            <aside class="column right-column resizable" data-column="right">
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <div class="panel-eyebrow">Continuon AI Agent Manager</div>
                            <h2>Threads & Guidance</h2>
                            <p class="panel-subtitle">Inline rail; no overlays for Flutter embed.</p>
                            <div id="persona-badge" class="persona-badge">Persona: default</div>
                        </div>
                        <div class="human-toggle" id="human-toggle" onclick="toggleHumanMode()">
                            <span>Human mode</span>
                            <strong id="human-toggle-state">Off</strong>
                        </div>
                    </div>
                    <div class="rail-actions">
                        <button class="rail-btn primary" onclick="resumeAgents()">‚ñ∂Ô∏è Resume agents</button>
                        <button class="rail-btn" onclick="pauseAgents()">‚è∏Ô∏è Pause agents</button>
                        <button class="rail-btn" onclick="reviewLearning()">üìí Review learning</button>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Active Agents</div>
                        <div class="agent-thread-list" id="agent-thread-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Model Stack & Fallbacks</div>
                        <div class="stack-list" id="model-stack-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Sub-agents & Tools</div>
                        <div class="stack-list" id="toolchain-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Training & Memories</div>
                        <div class="stack-list" id="training-memory-list"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Planner</div>
                        <div class="stack-list" id="planning-panel">
                            <div class="panel-subtitle">Goal in normalized joint space ([-1, 1])</div>
                            <div class="metric-row"><div class="metric-label">J0</div><div class="metric-value"><input id="plan-goal-j0" class="input-compact" type="number" step="0.05" value="0.2" style="width:120px;"></div></div>
                            <div class="metric-row"><div class="metric-label">J1</div><div class="metric-value"><input id="plan-goal-j1" class="input-compact" type="number" step="0.05" value="0.0" style="width:120px;"></div></div>
                            <div class="metric-row"><div class="metric-label">J2</div><div class="metric-value"><input id="plan-goal-j2" class="input-compact" type="number" step="0.05" value="0.0" style="width:120px;"></div></div>
                            <div class="metric-row"><div class="metric-label">J3</div><div class="metric-value"><input id="plan-goal-j3" class="input-compact" type="number" step="0.05" value="0.0" style="width:120px;"></div></div>
                            <div class="metric-row"><div class="metric-label">J4</div><div class="metric-value"><input id="plan-goal-j4" class="input-compact" type="number" step="0.05" value="0.0" style="width:120px;"></div></div>
                            <div class="metric-row"><div class="metric-label">J5</div><div class="metric-value"><input id="plan-goal-j5" class="input-compact" type="number" step="0.05" value="0.0" style="width:120px;"></div></div>
                            <div class="metric-row">
                                <div class="metric-label">Auto-exec step 0</div>
                                <div class="metric-value"><input id="plan-execute" type="checkbox"></div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">Motion gate</div>
                                <div class="metric-value">
                                    <span class="status-chip info" id="plan-motion-gate">--</span>
                                </div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label"> </div>
                                <div class="metric-value">
                                    <button class="rail-btn primary" onclick="window.runArmPlanner()">Plan</button>
                                    <button class="rail-btn" onclick="window.executeNextPlanStep()">Execute next</button>
                                    <button class="rail-btn" onclick="window.clearPlan()">Clear</button>
                                </div>
                            </div>
                            <div class="panel-subtitle">Plan steps</div>
                            <div id="plan-steps" class="stack-list"></div>
                            <div class="metric-row" style="margin-top:10px;">
                                <div class="metric-label">Show raw</div>
                                <div class="metric-value"><input id="plan-show-raw" type="checkbox"></div>
                            </div>
                            <pre id="plan-output" style="display:none; white-space:pre-wrap; font-size:12px; color:#cfe9ff; background:#0b1220; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); max-height:240px; overflow:auto;">(no plan yet)</pre>
                        </div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Robot Mode Self-Learning</div>
                        <div class="milestone-list" id="learning-milestones"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Recent Learning Events</div>
                        <div class="learning-list" id="learning-events"></div>
                    </div>
                    <div class="panel-ghost">
                        <div class="panel-eyebrow">Agent Chat</div>
                        <div class="chat-rail">
                            <div class="chat-messages inline" id="chat-messages"></div>
                            <div class="chat-structured-block" id="chat-structured-block" style="margin-top:12px;">
                                <div class="panel-eyebrow">Structured (goals / probes / plan)</div>
                                <pre id="chat-structured" style="white-space:pre-wrap; font-size:12px; color:#cfd7ff; background:#121826; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); max-height:260px; overflow:auto;">(no structured plan yet)</pre>
                            </div>
                            <div class="chat-input-area inline">
                                <input type="text" class="chat-input" id="chat-input"
                                    placeholder="Ask about robot status, control tips..."
                                    aria-label="Chat message input"
                                    onkeypress="if(event.key==='Enter') sendChatMessage()">
                                <button class="chat-send-btn" id="chat-send" onclick="sendChatMessage()">‚û§</button>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <script src="/static/client.js"></script>
    <script src="/static/mobile-shell.js"></script>
    <script src="/static/chat-overlay.js"></script>
    <script>
        // Initialize UI components
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize column resizers
            const grid = document.getElementById('workspace-grid');
            if (grid) {
                const leftHandle = document.querySelector('[data-resize="left"]');
                const rightHandle = document.querySelector('[data-resize="right"]');
                let leftWidth = 320;
                let rightWidth = 360;
                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
                const apply = () => {
                    if (window.innerWidth > 768) {
                        grid.style.gridTemplateColumns = `${leftWidth}px 10px 1fr 10px ${rightWidth}px`;
                    } else {
                        grid.style.gridTemplateColumns = '1fr';
                    }
                };

                // Initial apply
                apply();
                window.addEventListener('resize', apply);

                function startDrag(type) {
                    return function (event) {
                        event.preventDefault();
                        const startX = event.clientX;
                        const startLeft = leftWidth;
                        const startRight = rightWidth;
                        function onMove(e) {
                            const delta = e.clientX - startX;
                            if (type === 'left') {
                                leftWidth = clamp(startLeft + delta, 240, 520);
                            } else {
                                rightWidth = clamp(startRight - delta, 260, 520);
                            }
                            apply();
                        }
                        function onUp() {
                            document.removeEventListener('mousemove', onMove);
                            document.removeEventListener('mouseup', onUp);
                        }
                        document.addEventListener('mousemove', onMove);
                        document.addEventListener('mouseup', onUp);
                    };
                }

                leftHandle?.addEventListener('mousedown', startDrag('left'));
                rightHandle?.addEventListener('mousedown', startDrag('right'));
            }

            // Hydrate chat
            if (window.hydrateChatOverlay) {
                window.hydrateChatOverlay();
            }
        });
    </script>
</body>

</html>