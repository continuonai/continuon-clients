{% extends "base_v2.html" %}

{% block title %}Control Center - Continuon Brain{% endblock %}

{% block extra_styles %}
/* Control Center styles */
.control-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    height: calc(100vh - var(--header-height) - var(--footer-height) - 100px);
}

.camera-panel {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.camera-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-subtle);
}

.camera-title {
    font-size: 14px;
    font-weight: 600;
}

.camera-controls {
    display: flex;
    gap: 8px;
}

.camera-btn {
    padding: 6px 12px;
    background: var(--bg-glass);
    border: 1px solid var(--border-subtle);
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 11px;
    cursor: pointer;
    transition: all var(--duration-fast);
}

.camera-btn:hover {
    background: var(--bg-glass-hover);
    color: var(--text-primary);
}

.camera-btn.active {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.camera-feed {
    flex: 1;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    min-height: 400px;
}

.camera-feed img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.camera-placeholder {
    color: var(--text-muted);
    text-align: center;
}

.camera-placeholder .icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.camera-overlay {
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
}

.camera-stat {
    padding: 4px 8px;
    background: rgba(0,0,0,0.7);
    border-radius: 4px;
    font-size: 11px;
    color: var(--text-secondary);
}

/* Object Detection Panel */
.object-panel {
    background: var(--bg-elevated);
    border-top: 1px solid var(--border-subtle);
    padding: 12px;
    max-height: 150px;
    overflow-y: auto;
}

.object-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.object-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.object-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: var(--accent-primary-dim);
    border: 1px solid var(--accent-primary);
    border-radius: 12px;
    font-size: 11px;
    color: var(--accent-primary);
}

.object-tag .score {
    opacity: 0.7;
    font-size: 10px;
}

/* Controls Panel */
.controls-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.control-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 16px;
}

.control-card-header {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

/* Drive Controls */
.drive-pad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    max-width: 200px;
    margin: 0 auto;
}

.drive-btn {
    aspect-ratio: 1;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    font-size: 24px;
    cursor: pointer;
    transition: all var(--duration-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.drive-btn:hover {
    background: var(--accent-primary-dim);
    border-color: var(--accent-primary);
}

.drive-btn:active {
    background: var(--accent-primary);
    transform: scale(0.95);
}

.drive-btn.empty {
    background: transparent;
    border: none;
    cursor: default;
}

.drive-btn.stop {
    background: var(--accent-danger-dim);
    border-color: var(--accent-danger);
    color: var(--accent-danger);
}

/* Joint Controls */
.joint-sliders {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.joint-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.joint-label {
    width: 30px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
}

.joint-slider {
    flex: 1;
    -webkit-appearance: none;
    height: 6px;
    background: var(--bg-elevated);
    border-radius: 3px;
    outline: none;
}

.joint-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent-primary);
    border-radius: 50%;
    cursor: pointer;
    transition: all var(--duration-fast);
}

.joint-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

.joint-value {
    width: 50px;
    font-family: var(--font-mono);
    font-size: 12px;
    text-align: right;
}

/* Gripper Controls */
.gripper-controls {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.gripper-btn {
    flex: 1;
    padding: 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all var(--duration-fast);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.gripper-btn:hover {
    background: var(--bg-glass-hover);
    border-color: var(--border-default);
}

.gripper-btn .icon {
    font-size: 24px;
}

.gripper-btn .label {
    font-size: 11px;
    color: var(--text-muted);
}

/* Recording Controls */
.recording-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.record-btn {
    padding: 14px;
    background: var(--accent-danger-dim);
    border: 2px solid var(--accent-danger);
    border-radius: 10px;
    color: var(--accent-danger);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--duration-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.record-btn:hover {
    background: var(--accent-danger);
    color: white;
}

.record-btn.recording {
    background: var(--accent-danger);
    color: white;
    animation: recording-pulse 1s infinite;
}

@keyframes recording-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.record-status {
    text-align: center;
    font-size: 12px;
    color: var(--text-muted);
}

.record-status.active {
    color: var(--accent-danger);
}

/* Quick Poses */
.pose-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.pose-btn {
    padding: 10px;
    background: var(--bg-glass);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--duration-fast);
}

.pose-btn:hover {
    background: var(--bg-glass-hover);
    color: var(--text-primary);
}

@media (max-width: 900px) {
    .control-grid {
        grid-template-columns: 1fr;
    }
    
    .controls-panel {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
    }
}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Control Center</h1>
    <p class="page-subtitle">Manual robot control and teleoperation</p>
    <p class="help-text">Control the robot manually using the camera feed, drive pad, and arm joints. Use the RLDS recording feature to capture training demonstrations.</p>
</div>

<div class="control-grid">
    <!-- Camera Feed -->
    <div class="camera-panel">
        <div class="camera-header">
            <span class="camera-title">üì∑ Live Camera Feed</span>
            <div class="camera-controls">
                <button class="camera-btn active" data-mode="rgb" onclick="setCamera('rgb')">RGB</button>
                <button class="camera-btn" data-mode="depth" onclick="setCamera('depth')">Depth</button>
                <button class="camera-btn" data-mode="seg_rgb" onclick="setCamera('seg_rgb')">Seg+RGB</button>
                <button class="camera-btn" data-mode="seg_depth" onclick="setCamera('seg_depth')">Seg+D</button>
                <button class="camera-btn" data-mode="pose" onclick="setCamera('pose')">Pose</button>
                <button class="camera-btn" data-mode="pose_depth" onclick="setCamera('pose_depth')">Pose+D</button>
            </div>
        </div>
        <div class="camera-feed" id="camera-feed">
            <div class="camera-placeholder">
                <div class="icon">üì∑</div>
                <div>Camera feed loading...</div>
                <div style="font-size: 12px; margin-top: 8px;">Click to start stream</div>
            </div>
            <div class="camera-overlay">
                <span class="camera-stat" id="camera-fps">-- FPS</span>
                <span class="camera-stat" id="camera-resolution">--x--</span>
            </div>
        </div>
        <!-- Object Detection Panel -->
        <div class="object-panel" id="object-panel" style="display: none;">
            <div class="object-panel-header">
                <span>üéØ Detected Objects</span>
                <span id="object-count">0 objects</span>
            </div>
            <div class="object-list" id="object-list"></div>
        </div>
        <!-- Pose Detection Panel -->
        <div class="object-panel" id="pose-panel" style="display: none;">
            <div class="object-panel-header">
                <span>üèÉ Detected Poses</span>
                <span id="pose-count">0 people</span>
            </div>
            <div class="object-list" id="pose-list"></div>
        </div>
    </div>
    
    <!-- Controls Panel -->
    <div class="controls-panel">
        <!-- Drive Pad -->
        <div class="control-card" title="Use arrow buttons to drive the robot base. Press and hold to move, release to stop.">
            <div class="control-card-header">üöó Drive Controls<span class="info-badge" title="Press and hold directional buttons to move. Center button is emergency stop.">?</span></div>
            <div class="drive-pad">
                <div class="drive-btn empty"></div>
                <button class="drive-btn" onmousedown="drive('forward')" onmouseup="drive('stop')">‚¨ÜÔ∏è</button>
                <div class="drive-btn empty"></div>
                <button class="drive-btn" onmousedown="drive('left')" onmouseup="drive('stop')">‚¨ÖÔ∏è</button>
                <button class="drive-btn stop" onclick="drive('stop')">‚èπÔ∏è</button>
                <button class="drive-btn" onmousedown="drive('right')" onmouseup="drive('stop')">‚û°Ô∏è</button>
                <div class="drive-btn empty"></div>
                <button class="drive-btn" onmousedown="drive('backward')" onmouseup="drive('stop')">‚¨áÔ∏è</button>
                <div class="drive-btn empty"></div>
            </div>
        </div>
        
        <!-- Left Arm Joints -->
        <div class="control-card" title="Control individual joint angles for the left arm. L1-L6 represent shoulder to wrist joints.">
            <div class="control-card-header">ü¶æ Left Arm<span class="info-badge" title="Drag sliders to set joint angles (degrees). Values update in real-time.">?</span></div>
            <div class="joint-sliders">
                <div class="joint-row">
                    <span class="joint-label">L1</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('left', 0, this.value)">
                    <span class="joint-value" id="left-joint-0">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">L2</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('left', 1, this.value)">
                    <span class="joint-value" id="left-joint-1">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">L3</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('left', 2, this.value)">
                    <span class="joint-value" id="left-joint-2">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">L4</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('left', 3, this.value)">
                    <span class="joint-value" id="left-joint-3">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">L5</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('left', 4, this.value)">
                    <span class="joint-value" id="left-joint-4">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">L6</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('left', 5, this.value)">
                    <span class="joint-value" id="left-joint-5">0¬∞</span>
                </div>
            </div>
            <div class="gripper-controls" style="margin-top: 12px;">
                <button class="gripper-btn" onclick="gripper('left', 'open')">
                    <span class="icon">üñêÔ∏è</span>
                    <span class="label">Open</span>
                </button>
                <button class="gripper-btn" onclick="gripper('left', 'close')">
                    <span class="icon">‚úä</span>
                    <span class="label">Close</span>
                </button>
            </div>
        </div>

        <!-- Right Arm Joints -->
        <div class="control-card" title="Control individual joint angles for the right arm. R1-R6 represent shoulder to wrist joints.">
            <div class="control-card-header">ü¶æ Right Arm<span class="info-badge" title="Drag sliders to set joint angles (degrees). Values update in real-time.">?</span></div>
            <div class="joint-sliders">
                <div class="joint-row">
                    <span class="joint-label">R1</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('right', 0, this.value)">
                    <span class="joint-value" id="right-joint-0">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">R2</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('right', 1, this.value)">
                    <span class="joint-value" id="right-joint-1">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">R3</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('right', 2, this.value)">
                    <span class="joint-value" id="right-joint-2">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">R4</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('right', 3, this.value)">
                    <span class="joint-value" id="right-joint-3">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">R5</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('right', 4, this.value)">
                    <span class="joint-value" id="right-joint-4">0¬∞</span>
                </div>
                <div class="joint-row">
                    <span class="joint-label">R6</span>
                    <input type="range" class="joint-slider" min="-180" max="180" value="0"
                           oninput="updateJoint('right', 5, this.value)">
                    <span class="joint-value" id="right-joint-5">0¬∞</span>
                </div>
            </div>
            <div class="gripper-controls" style="margin-top: 12px;">
                <button class="gripper-btn" onclick="gripper('right', 'open')">
                    <span class="icon">üñêÔ∏è</span>
                    <span class="label">Open</span>
                </button>
                <button class="gripper-btn" onclick="gripper('right', 'close')">
                    <span class="icon">‚úä</span>
                    <span class="label">Close</span>
                </button>
            </div>
        </div>

        <!-- Gripper (Head/Common) -->
        <div class="control-card" title="Control the gripper end effector to grasp or release objects.">
            <div class="control-card-header">‚úä Gripper<span class="info-badge" title="Open to release, Close to grasp objects.">?</span></div>
            <div class="gripper-controls">
                <button class="gripper-btn" onclick="gripper('open')">
                    <span class="icon">üñêÔ∏è</span>
                    <span class="label">Open</span>
                </button>
                <button class="gripper-btn" onclick="gripper('close')">
                    <span class="icon">‚úä</span>
                    <span class="label">Close</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Poses -->
        <div class="control-card" title="Pre-defined arm positions for common tasks.">
            <div class="control-card-header">üìê Quick Poses<span class="info-badge" title="Click to move both arms to predefined positions: Home (neutral), Ready (prepared), Reach (extended), Rest (folded).">?</span></div>
            <div class="pose-grid">
                <button class="pose-btn" onclick="setPose('home')">üè† Home</button>
                <button class="pose-btn" onclick="setPose('ready')">‚úã Ready</button>
                <button class="pose-btn" onclick="setPose('reach')">üëÜ Reach</button>
                <button class="pose-btn" onclick="setPose('rest')">üò¥ Rest</button>
            </div>
        </div>
        
        <!-- Recording -->
        <div class="control-card" title="Record robot demonstrations for training data (RLDS format).">
            <div class="control-card-header">üî¥ RLDS Recording<span class="info-badge" title="Robot Learning from Demonstrations: Record your manual control as training data. Episodes are stored locally and can be used for imitation learning.">?</span></div>
            <div class="recording-section">
                <button class="record-btn" id="record-btn" onclick="toggleRecording()">
                    <span>‚è∫Ô∏è</span>
                    <span id="record-label">Start Recording</span>
                </button>
                <div class="record-status" id="record-status">Not recording</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Control Center logic
let isRecording = false;
let cameraStream = null;
let cameraMode = 'rgb';

// Camera
let segmentationInterval = null;
let poseInterval = null;

function setCamera(mode) {
    cameraMode = mode;
    document.querySelectorAll('.camera-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    startCameraStream();

    // Show/hide object panel and start/stop polling for segmentation modes
    const objectPanel = document.getElementById('object-panel');
    if (mode.includes('seg')) {
        objectPanel.style.display = 'block';
        startSegmentationPolling();
    } else {
        objectPanel.style.display = 'none';
        stopSegmentationPolling();
    }

    // Show/hide pose panel and start/stop polling for pose modes
    const posePanel = document.getElementById('pose-panel');
    if (mode.includes('pose')) {
        posePanel.style.display = 'block';
        startPosePolling();
    } else {
        posePanel.style.display = 'none';
        stopPosePolling();
    }
}

function startCameraStream() {
    const feed = document.getElementById('camera-feed');
    const streamUrl = `/api/camera/stream?mode=${cameraMode}&t=${Date.now()}`;

    feed.innerHTML = `
        <img src="${streamUrl}" alt="Camera feed" onerror="cameraError()" onload="refreshCameraStream()">
        <div class="camera-overlay">
            <span class="camera-stat" id="camera-fps">30 FPS</span>
            <span class="camera-stat" id="camera-resolution">640x400</span>
        </div>
    `;
}

function refreshCameraStream() {
    // Auto-refresh camera frame for continuous streaming
    setTimeout(() => {
        const img = document.querySelector('#camera-feed img');
        if (img) {
            img.src = `/api/camera/stream?mode=${cameraMode}&t=${Date.now()}`;
        }
    }, 100);  // ~10 FPS refresh rate
}

function cameraError() {
    const feed = document.getElementById('camera-feed');
    feed.innerHTML = `
        <div class="camera-placeholder">
            <div class="icon">‚ö†Ô∏è</div>
            <div>Camera not available</div>
            <div style="font-size: 12px; margin-top: 8px;">Check hardware connection</div>
        </div>
    `;
}

function startSegmentationPolling() {
    if (segmentationInterval) return;
    segmentationInterval = setInterval(fetchSegmentationData, 500);
    fetchSegmentationData();  // Immediate first fetch
}

function stopSegmentationPolling() {
    if (segmentationInterval) {
        clearInterval(segmentationInterval);
        segmentationInterval = null;
    }
}

async function fetchSegmentationData() {
    try {
        const response = await fetch('/api/vision/segmentation');
        const data = await response.json();
        updateObjectPanel(data);
    } catch (error) {
        console.error('Failed to fetch segmentation:', error);
    }
}

function updateObjectPanel(data) {
    const countEl = document.getElementById('object-count');
    const listEl = document.getElementById('object-list');

    if (!data.objects || data.objects.length === 0) {
        countEl.textContent = '0 objects';
        listEl.innerHTML = '<span style="color: var(--text-muted); font-size: 11px;">No objects detected</span>';
        return;
    }

    countEl.textContent = `${data.objects.length} object${data.objects.length > 1 ? 's' : ''}`;

    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8', '#f7dc6f'];

    listEl.innerHTML = data.objects.map((obj, i) => `
        <span class="object-tag" style="border-color: ${colors[i % colors.length]}; color: ${colors[i % colors.length]}">
            <span>Obj${obj.id}</span>
            <span class="score">${(obj.score * 100).toFixed(0)}%</span>
        </span>
    `).join('');
}

// Pose Detection Polling
function startPosePolling() {
    if (poseInterval) return;
    poseInterval = setInterval(fetchPoseData, 500);
    fetchPoseData();  // Immediate first fetch
}

function stopPosePolling() {
    if (poseInterval) {
        clearInterval(poseInterval);
        poseInterval = null;
    }
}

async function fetchPoseData() {
    try {
        const response = await fetch('/api/vision/pose');
        const data = await response.json();
        updatePosePanel(data);
    } catch (error) {
        console.error('Failed to fetch pose:', error);
    }
}

function updatePosePanel(data) {
    const countEl = document.getElementById('pose-count');
    const listEl = document.getElementById('pose-list');

    if (!data.poses || data.poses.length === 0) {
        countEl.textContent = '0 people';
        listEl.innerHTML = '<span style="color: var(--text-muted); font-size: 11px;">No poses detected</span>';
        return;
    }

    countEl.textContent = `${data.poses.length} ${data.poses.length === 1 ? 'person' : 'people'}`;

    const colors = ['#4ecdc4', '#ff6b6b', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd'];

    listEl.innerHTML = data.poses.map((pose, i) => `
        <span class="object-tag" style="border-color: ${colors[i % colors.length]}; color: ${colors[i % colors.length]}">
            <span>Person ${pose.person_id}</span>
            <span class="score">${(pose.confidence * 100).toFixed(0)}%</span>
        </span>
    `).join('') + (data.wrists && data.wrists.length > 0 ? `
        <span class="object-tag" style="border-color: #ffd93d; color: #ffd93d; margin-left: 8px;">
            <span>üñêÔ∏è ${data.wrists.length} wrist${data.wrists.length > 1 ? 's' : ''}</span>
        </span>
    ` : '');
}

// Drive controls
async function drive(direction) {
    const commands = {
        forward: { linear: 0.3, angular: 0 },
        backward: { linear: -0.3, angular: 0 },
        left: { linear: 0, angular: 0.5 },
        right: { linear: 0, angular: -0.5 },
        stop: { linear: 0, angular: 0 }
    };
    
    try {
        await fetch('/api/robot/drive', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(commands[direction] || commands.stop)
        });
    } catch (error) {
        console.error('Drive command failed:', error);
    }
}

// Joint controls for dual arms
let jointDebounce = {};
function updateJoint(arm, index, value) {
    document.getElementById(`${arm}-joint-${index}`).textContent = `${value}¬∞`;

    // Debounce API calls per arm
    clearTimeout(jointDebounce[arm]);
    jointDebounce[arm] = setTimeout(async () => {
        const joints = [];
        for (let i = 0; i < 6; i++) {
            const el = document.getElementById(`${arm}-joint-${i}`);
            const slider = el.parentElement.querySelector('.joint-slider');
            joints.push(parseFloat(slider.value));
        }

        try {
            await fetch('/api/robot/joints', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ arm: arm, positions: joints })
            });
        } catch (error) {
            console.error(`${arm} arm joint update failed:`, error);
        }
    }, 100);
}

// Gripper control for dual arms
async function gripper(arm, action) {
    // Handle both single gripper (action only) and dual arm gripper
    const payload = typeof action === 'undefined'
        ? { action: arm }  // Old single-gripper call: gripper('open')
        : { arm: arm, action: action };  // Dual-arm call: gripper('left', 'open')

    try {
        await fetch('/api/robot/gripper', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } catch (error) {
        console.error('Gripper command failed:', error);
    }
}

// Quick poses
async function setPose(pose) {
    try {
        await fetch(`/api/robot/pose/${pose}`, { method: 'POST' });
    } catch (error) {
        console.error('Pose command failed:', error);
    }
}

// Recording
async function toggleRecording() {
    isRecording = !isRecording;
    const btn = document.getElementById('record-btn');
    const label = document.getElementById('record-label');
    const status = document.getElementById('record-status');
    
    if (isRecording) {
        btn.classList.add('recording');
        label.textContent = 'Stop Recording';
        status.textContent = 'Recording RLDS episode...';
        status.classList.add('active');
        
        try {
            await fetch('/api/training/record/start', { method: 'POST' });
        } catch (error) {
            console.error('Recording start failed:', error);
        }
    } else {
        btn.classList.remove('recording');
        label.textContent = 'Start Recording';
        status.textContent = 'Not recording';
        status.classList.remove('active');
        
        try {
            await fetch('/api/training/record/stop', { method: 'POST' });
        } catch (error) {
            console.error('Recording stop failed:', error);
        }
    }
}

// Initialize camera on click
document.getElementById('camera-feed').addEventListener('click', startCameraStream);
{% endblock %}

