{% extends "base_v2.html" %}

{% block title %}Dashboard - Continuon Brain{% endblock %}

{% block extra_styles %}
/* Dashboard specific styles */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.metric-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    transition: all var(--duration-fast);
}

.metric-card:hover {
    border-color: var(--border-default);
    box-shadow: var(--shadow-md);
}

.metric-icon {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-bottom: 16px;
}

.metric-icon.primary { background: var(--accent-primary-dim); }
.metric-icon.success { background: var(--accent-success-dim); }
.metric-icon.warning { background: var(--accent-warning-dim); }
.metric-icon.info { background: rgba(59, 130, 246, 0.15); }

.metric-value {
    font-family: var(--font-display);
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
}

.metric-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-trend {
    margin-top: auto;
    padding-top: 12px;
    font-size: 12px;
    color: var(--text-muted);
}

.metric-trend.up { color: var(--accent-success); }
.metric-trend.down { color: var(--accent-danger); }

/* Section headers */
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.section-title {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.section-badge {
    padding: 4px 10px;
    background: var(--bg-glass);
    border-radius: 20px;
    font-size: 11px;
    color: var(--text-muted);
}

/* Hardware cards */
.hardware-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}

.hardware-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    padding: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.hardware-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--bg-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.hardware-info {
    flex: 1;
    min-width: 0;
}

.hardware-name {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.hardware-detail {
    font-size: 11px;
    color: var(--text-muted);
}

.hardware-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.hardware-status.online { background: var(--accent-success); }
.hardware-status.offline { background: var(--accent-danger); }
.hardware-status.unknown { background: var(--text-muted); }

/* RCAN Sessions */
.rcan-panel {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.rcan-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.rcan-title {
    display: flex;
    align-items: center;
    gap: 10px;
}

.rcan-title h3 {
    font-size: 14px;
    font-weight: 600;
}

.rcan-badge {
    padding: 3px 8px;
    background: var(--accent-success-dim);
    color: var(--accent-success);
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.rcan-ruri {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-muted);
    padding: 8px 12px;
    background: var(--bg-elevated);
    border-radius: 6px;
    margin-bottom: 16px;
}

.rcan-capabilities {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.rcan-cap {
    padding: 4px 10px;
    background: var(--bg-glass);
    border-radius: 4px;
    font-size: 11px;
    color: var(--text-secondary);
}

/* Mode Ring */
.mode-ring-container {
    display: flex;
    align-items: center;
    gap: 24px;
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.mode-ring {
    width: 100px;
    height: 100px;
    position: relative;
}

.mode-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.mode-ring-bg {
    fill: none;
    stroke: var(--bg-elevated);
    stroke-width: 8;
}

.mode-ring-fill {
    fill: none;
    stroke: var(--mode-autonomous);
    stroke-width: 8;
    stroke-linecap: round;
    stroke-dasharray: 283;
    stroke-dashoffset: 70;
    transition: all var(--duration-slow);
}

.mode-ring-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.mode-ring-value {
    font-family: var(--font-display);
    font-size: 24px;
    font-weight: 700;
}

.mode-ring-label {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
}

.mode-info {
    flex: 1;
}

.mode-info h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
}

.mode-info p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.mode-stats {
    display: flex;
    gap: 24px;
}

.mode-stat {
    display: flex;
    flex-direction: column;
}

.mode-stat-value {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 600;
}

.mode-stat-label {
    font-size: 11px;
    color: var(--text-muted);
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.quick-action-btn {
    padding: 10px 18px;
    background: var(--bg-glass);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--duration-fast);
    display: flex;
    align-items: center;
    gap: 8px;
}

.quick-action-btn:hover {
    background: var(--bg-glass-hover);
    border-color: var(--border-default);
}

.quick-action-btn.primary {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
}

.quick-action-btn.primary:hover {
    filter: brightness(1.1);
}

/* Live Events */
.events-panel {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 16px;
    max-height: 300px;
    overflow-y: auto;
}

.event-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-subtle);
}

.event-item:last-child {
    border-bottom: none;
}

.event-time {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-muted);
    flex-shrink: 0;
    width: 70px;
}

.event-content {
    flex: 1;
    font-size: 13px;
}

.event-type {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    margin-left: 8px;
}

.event-type.info { background: rgba(59, 130, 246, 0.15); color: var(--accent-info); }
.event-type.success { background: var(--accent-success-dim); color: var(--accent-success); }
.event-type.warning { background: var(--accent-warning-dim); color: var(--accent-warning); }
.event-type.error { background: var(--accent-danger-dim); color: var(--accent-danger); }
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">Real-time robot status and control center</p>
</div>

<!-- Mode Status Ring -->
<div class="mode-ring-container">
    <div class="mode-ring">
        <svg viewBox="0 0 100 100">
            <circle class="mode-ring-bg" cx="50" cy="50" r="45"></circle>
            <circle class="mode-ring-fill" id="mode-ring-fill" cx="50" cy="50" r="45"></circle>
        </svg>
        <div class="mode-ring-text">
            <div class="mode-ring-value" id="mode-ring-value">--</div>
            <div class="mode-ring-label">MODE</div>
        </div>
    </div>
    <div class="mode-info">
        <h3 id="mode-name">Initializing...</h3>
        <p id="mode-description">Loading robot status...</p>
        <div class="mode-stats">
            <div class="mode-stat">
                <span class="mode-stat-value" id="fast-loop-hz">--</span>
                <span class="mode-stat-label">Fast Loop Hz</span>
            </div>
            <div class="mode-stat">
                <span class="mode-stat-value" id="mid-loop-hz">--</span>
                <span class="mode-stat-label">Mid Loop Hz</span>
            </div>
            <div class="mode-stat">
                <span class="mode-stat-value" id="slow-loop-hz">--</span>
                <span class="mode-stat-label">Slow Loop Hz</span>
            </div>
            <div class="mode-stat">
                <span class="mode-stat-value" id="wave-particle">--</span>
                <span class="mode-stat-label">Wave/Particle</span>
            </div>
        </div>
    </div>
    <div class="quick-actions">
        <button class="quick-action-btn primary" onclick="setMode('autonomous')">ðŸš€ Go Autonomous</button>
        <button class="quick-action-btn" onclick="window.location.href='/pair'">ðŸ“± Pair App</button>
        <button class="quick-action-btn" onclick="triggerChatLearn()">ðŸ§  Learn Session</button>
    </div>
</div>

<!-- RCAN Status -->
<div class="rcan-panel">
    <div class="rcan-header">
        <div class="rcan-title">
            <h3>ðŸ“¡ RCAN Identity</h3>
            <span class="rcan-badge" id="rcan-status-badge">ONLINE</span>
        </div>
    </div>
    <div class="rcan-ruri" id="rcan-ruri-display">rcan://continuon.cloud/continuon/companion-v1/loading...</div>
    <div class="rcan-capabilities" id="rcan-capabilities">
        <span class="rcan-cap">Loading...</span>
    </div>
</div>

<!-- Key Metrics -->
<div class="section-header">
    <span class="section-title">Key Metrics</span>
    <span class="section-badge">Live</span>
</div>
<div class="dashboard-grid">
    <div class="metric-card">
        <div class="metric-icon success">ðŸ§ </div>
        <div class="metric-value" id="cms-memory">--</div>
        <div class="metric-label">CMS Memory Usage</div>
        <div class="metric-trend" id="cms-trend">Fast: -- | Mid: -- | Slow: --</div>
    </div>
    <div class="metric-card">
        <div class="metric-icon primary">âš¡</div>
        <div class="metric-value" id="inference-latency">--ms</div>
        <div class="metric-label">Inference Latency</div>
        <div class="metric-trend" id="inference-trend">Target: <20ms</div>
    </div>
    <div class="metric-card">
        <div class="metric-icon warning">ðŸ“Š</div>
        <div class="metric-value" id="rlds-count">--</div>
        <div class="metric-label">RLDS Episodes</div>
        <div class="metric-trend" id="rlds-trend">Local storage</div>
    </div>
    <div class="metric-card">
        <div class="metric-icon info">ðŸŽ¯</div>
        <div class="metric-value" id="benchmark-score">--</div>
        <div class="metric-label">Benchmark Score</div>
        <div class="metric-trend" id="benchmark-level">Level: --</div>
    </div>
</div>

<!-- Hardware Status -->
<div class="section-header">
    <span class="section-title">Hardware Status</span>
    <span class="section-badge" id="hardware-count">0 devices</span>
</div>
<div class="hardware-grid" id="hardware-grid">
    <div class="hardware-card">
        <div class="hardware-icon">ðŸ”Œ</div>
        <div class="hardware-info">
            <div class="hardware-name">Scanning...</div>
            <div class="hardware-detail">Detecting hardware</div>
        </div>
        <div class="hardware-status unknown"></div>
    </div>
</div>

<!-- Recent Events -->
<div class="section-header" style="margin-top: 24px;">
    <span class="section-title">Recent Events</span>
    <button class="quick-action-btn" onclick="fetchEvents()" style="padding: 6px 12px; font-size: 11px;">Refresh</button>
</div>
<div class="events-panel" id="events-panel">
    <div class="event-item">
        <span class="event-time">--:--:--</span>
        <span class="event-content">Waiting for events...</span>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Dashboard-specific logic
let dashboardData = {};

// Mode colors
const modeColors = {
    'autonomous': '#10b981',
    'manual_control': '#f59e0b',
    'sleep_learning': '#6366f1',
    'idle': '#64748b',
    'safety_hold': '#ef4444'
};

const modeDescriptions = {
    'autonomous': 'Robot is operating independently with full HOPE agent control.',
    'manual_control': 'Direct human control via teleoperation or joystick.',
    'sleep_learning': 'Background training from RLDS episodes and chat learning.',
    'idle': 'Waiting for commands. Minimal power consumption.',
    'safety_hold': 'Emergency safety hold active. All motion stopped.'
};

function updateDashboard(status, rcan) {
    // Mode ring
    const mode = status.mode || 'idle';
    const modeColor = modeColors[mode] || modeColors.idle;
    const modeFill = document.getElementById('mode-ring-fill');
    modeFill.style.stroke = modeColor;
    modeFill.style.strokeDashoffset = mode === 'autonomous' ? 0 : 141; // 50% or 100%
    
    document.getElementById('mode-ring-value').textContent = mode.split('_')[0].toUpperCase();
    document.getElementById('mode-name').textContent = mode.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    document.getElementById('mode-description').textContent = modeDescriptions[mode] || 'Unknown mode';
    
    // Loop rates
    if (status.loop_metrics && status.loop_metrics.hope_loops) {
        const loops = status.loop_metrics.hope_loops;
        document.getElementById('fast-loop-hz').textContent = loops.fast?.hz?.toFixed(0) || '--';
        document.getElementById('mid-loop-hz').textContent = loops.mid?.hz?.toFixed(1) || '--';
        document.getElementById('slow-loop-hz').textContent = loops.slow?.hz?.toFixed(2) || '--';
    }
    
    // Wave/Particle ratio
    if (status.wave_particle_balance) {
        const ratio = status.wave_particle_balance;
        document.getElementById('wave-particle').textContent = `${(ratio.wave * 100).toFixed(0)}/${(ratio.particle * 100).toFixed(0)}`;
    }
    
    // RCAN
    if (rcan) {
        document.getElementById('rcan-ruri-display').textContent = rcan.ruri || 'Unknown';
        document.getElementById('rcan-status-badge').textContent = rcan.status === 'active' ? 'ONLINE' : 'OFFLINE';
        document.getElementById('rcan-status-badge').style.background = 
            rcan.status === 'active' ? 'var(--accent-success-dim)' : 'var(--accent-danger-dim)';
        document.getElementById('rcan-status-badge').style.color = 
            rcan.status === 'active' ? 'var(--accent-success)' : 'var(--accent-danger)';
        
        if (rcan.capabilities) {
            const caps = Array.isArray(rcan.capabilities) ? rcan.capabilities : [];
            document.getElementById('rcan-capabilities').innerHTML = 
                caps.map(c => `<span class="rcan-cap">${c}</span>`).join('') || '<span class="rcan-cap">None</span>';
        }
    }
    
    // CMS Memory
    if (status.cms_state) {
        const cms = status.cms_state;
        const totalUsed = (cms.fast_used || 0) + (cms.mid_used || 0) + (cms.slow_used || 0);
        const totalCap = (cms.fast_capacity || 1) + (cms.mid_capacity || 1) + (cms.slow_capacity || 1);
        document.getElementById('cms-memory').textContent = `${((totalUsed / totalCap) * 100).toFixed(0)}%`;
        document.getElementById('cms-trend').textContent = 
            `Fast: ${cms.fast_used || 0} | Mid: ${cms.mid_used || 0} | Slow: ${cms.slow_used || 0}`;
    }
    
    // Inference latency
    if (status.loop_metrics && status.loop_metrics.inference_ms) {
        const latency = status.loop_metrics.inference_ms;
        document.getElementById('inference-latency').textContent = `${latency.toFixed(1)}ms`;
        document.getElementById('inference-trend').className = 'metric-trend ' + (latency < 20 ? 'up' : 'down');
        document.getElementById('inference-trend').textContent = latency < 20 ? 'âœ“ Target met' : 'âš  Above target';
    }
    
    // RLDS count
    if (status.rlds_episode_count !== undefined) {
        document.getElementById('rlds-count').textContent = status.rlds_episode_count.toLocaleString();
    }
    
    // Benchmark
    if (status.benchmark) {
        document.getElementById('benchmark-score').textContent = status.benchmark.score?.toFixed(2) || '--';
        document.getElementById('benchmark-level').textContent = `Level: ${status.benchmark.level || '--'}`;
    }
}

async function fetchHardware() {
    try {
        const response = await fetch('/api/runtime/hardware');
        const data = await response.json();
        updateHardwareGrid(data);
    } catch (error) {
        console.error('Hardware fetch failed:', error);
    }
}

function updateHardwareGrid(hardware) {
    const grid = document.getElementById('hardware-grid');
    const devices = [];
    
    // CPU
    if (hardware.cpu) {
        devices.push({
            icon: 'ðŸ’»',
            name: hardware.cpu.model || 'CPU',
            detail: `${hardware.cpu.cores || '?'} cores @ ${hardware.cpu.usage?.toFixed(0) || '--'}%`,
            online: true
        });
    }
    
    // RAM
    if (hardware.system) {
        devices.push({
            icon: 'ðŸ§ ',
            name: 'System RAM',
            detail: `${hardware.system.ram_available_gb?.toFixed(1) || '--'}GB / ${hardware.system.ram_total_gb?.toFixed(1) || '--'}GB`,
            online: true
        });
    }
    
    // Camera
    if (hardware.camera) {
        devices.push({
            icon: 'ðŸ“·',
            name: hardware.camera.name || 'Camera',
            detail: hardware.camera.resolution || 'Unknown',
            online: hardware.camera.connected
        });
    }
    
    // Hailo NPU
    if (hardware.hailo) {
        devices.push({
            icon: 'âš¡',
            name: 'Hailo NPU',
            detail: hardware.hailo.model || 'Hailo-8',
            online: hardware.hailo.connected
        });
    }
    
    // OAK-D
    if (hardware.oakd) {
        devices.push({
            icon: 'ðŸ‘ï¸',
            name: 'OAK-D Camera',
            detail: hardware.oakd.serial || 'Depth + RGB',
            online: hardware.oakd.connected
        });
    }
    
    // Arms
    if (hardware.arms) {
        hardware.arms.forEach((arm, i) => {
            devices.push({
                icon: 'ðŸ¦¾',
                name: arm.name || `Arm ${i + 1}`,
                detail: `${arm.joints || 6} joints`,
                online: arm.connected
            });
        });
    }
    
    // Default if no devices
    if (devices.length === 0) {
        devices.push({
            icon: 'ðŸ”Œ',
            name: 'No hardware detected',
            detail: 'Connect devices to get started',
            online: false
        });
    }
    
    // Update count
    document.getElementById('hardware-count').textContent = `${devices.length} devices`;
    
    // Render
    grid.innerHTML = devices.map(d => `
        <div class="hardware-card">
            <div class="hardware-icon">${d.icon}</div>
            <div class="hardware-info">
                <div class="hardware-name">${d.name}</div>
                <div class="hardware-detail">${d.detail}</div>
            </div>
            <div class="hardware-status ${d.online ? 'online' : 'offline'}"></div>
        </div>
    `).join('');
}

async function fetchEvents() {
    try {
        const response = await fetch('/api/system/events?limit=10');
        const data = await response.json();
        updateEventsPanel(data.events || []);
    } catch (error) {
        console.error('Events fetch failed:', error);
    }
}

function updateEventsPanel(events) {
    const panel = document.getElementById('events-panel');
    
    if (events.length === 0) {
        panel.innerHTML = `
            <div class="event-item">
                <span class="event-time">--:--:--</span>
                <span class="event-content">No recent events</span>
            </div>
        `;
        return;
    }
    
    panel.innerHTML = events.map(e => {
        const time = new Date(e.timestamp || Date.now()).toLocaleTimeString();
        const type = e.type || 'info';
        return `
            <div class="event-item">
                <span class="event-time">${time}</span>
                <span class="event-content">${escapeHtml(e.message || e.event || 'Unknown event')}</span>
                <span class="event-type ${type}">${type}</span>
            </div>
        `;
    }).join('');
}

async function triggerChatLearn() {
    try {
        const response = await fetch('/api/training/chat_learn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ turns: 5 })
        });
        const data = await response.json();
        alert('Learning session started! ' + (data.message || ''));
    } catch (error) {
        alert('Failed to start learning session: ' + error.message);
    }
}

// Override base status update
const baseUpdateUI = updateUI;
function updateUI(status, rcan) {
    baseUpdateUI(status, rcan);
    updateDashboard(status, rcan);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    fetchHardware();
    fetchEvents();
    setInterval(fetchHardware, 10000);
    setInterval(fetchEvents, 5000);
});
{% endblock %}

